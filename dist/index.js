(()=>{"use strict";function t(t){return t&&"object"==typeof t?t:null}function e(e){return!e.is_user&&!e.is_system&&!function(e){const n=t(e.extra);if(!n)return!1;const a=Array.isArray(n.media)?n.media:[];for(const e of a){const n=t(e);if(n){if("generated"===String(n.source??"").trim().toLowerCase())return!0;if("number"==typeof n.generation_type)return!0}}return"number"==typeof n.generation_type}(e)}function n(t){const n=function(t){if(!t.groupId||!t.groups||!t.characters)return[];const e=t.groups.find(e=>e.id===t.groupId);if(!e?.members?.length)return[];const n=new Set(e.disabled_members??[]);return t.characters.filter(t=>t.avatar&&e.members?.includes(t.avatar)&&!n.has(t.avatar))}(t);if(n.length)return n.map(t=>t.name).filter(Boolean);if(t.groupId){const n=Array.from(new Set(t.chat.filter(t=>e(t)).map(t=>String(t.name??"").trim()).filter(Boolean)));if(n.length)return n}const a=function(t){if(!t.characters||void 0===t.characterId)return[];const e=t.characters[t.characterId];return e?[e]:[]}(t);return a.length?a.map(t=>t.name).filter(Boolean):t.name2?[t.name2]:[]}const a="bettersimtracker",s="bst-styles",o=["affection","trust","desire","connection","mood","lastThought"];async function r(t){const e=await fetch("/api/backends/chat-completions/generate",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-Token":SillyTavern.getContext().csrf_token??""},body:JSON.stringify(t)}),n=await e.text();let a=null;try{a=JSON.parse(n)}catch{a=null}const s=a?function(t){if("string"==typeof t.content)return t.content;const e=t.choices?.[0];return e?.message?.content??e?.text??""}(a).trim():"",o=Boolean(a?.error);if(!e.ok||o||!s)throw new Error(`Generation request failed (${e.status}): ${n}`);return s}async function i(t,e){const n=function(t){const e=t.connectionProfile?.trim();if(e&&"default"!==e.toLowerCase())return e}(e);if(!n)try{return await async function(t){const e=Function("return import('/script.js')"),n=(await e()).generateQuietPrompt;if("function"!=typeof n)throw new Error("generateQuietPrompt not available from /script.js");const a=await n({quietPrompt:t,responseLength:300,removeReasoning:!0}),s=String(a??"").trim();if(!s)throw new Error("generateQuietPrompt returned empty output");return s}(t)}catch{}const a=[{prompt:t,profileId:n,temperature:.3,max_tokens:300,no_cache:!0,quiet_to_console:!0},{messages:[{role:"user",content:t}],profileId:n,temperature:.3,max_tokens:300,no_cache:!0,quiet_to_console:!0},{prompt:t,temperature:.3,max_tokens:300,no_cache:!0,quiet_to_console:!0},{messages:[{role:"user",content:t}],temperature:.3,max_tokens:300,no_cache:!0,quiet_to_console:!0}],s=[];for(const t of a)try{return await r(t)}catch(t){s.push(t instanceof Error?t.message:String(t))}throw new Error(s.join(" | "))}function c(t){if("string"!=typeof t)return null;const e=t.trim();return e?e.slice(0,200):null}function l(t,e,n,a=15){const s=function(t){try{return JSON.parse(t)}catch{const e=t.match(/\{[\s\S]*\}/);if(!e)return null;try{return JSON.parse(e[0])}catch{return null}}}(t),o=new Set(n),r=new Map,i={confidence:{},deltas:{affection:{},trust:{},desire:{},connection:{}},mood:{},lastThought:{}};if(!s||"object"!=typeof s)return i;const l=s,d=Array.isArray(l.characters)?l.characters:null;if(d)for(const t of d){if(!t||"object"!=typeof t)continue;const e=t,n=String(e.name??"").trim();n&&r.set(n,e)}const u=Math.max(1,Math.round(Number(a)||15)),g=t=>Math.max(-u,Math.min(u,Math.round(t))),p=t=>{if("number"==typeof t&&Number.isFinite(t))return g(t);if("string"==typeof t){const e=Number(t);if(!Number.isNaN(e))return g(e)}return null};for(const t of e){const e=r.get(t);if(!e)continue;const n=Number(e.confidence);Number.isNaN(n)||(i.confidence[t]=Math.max(0,Math.min(1,n)));const a=e.delta&&"object"==typeof e.delta?e.delta:null;if(o.has("affection")){const n=p(a?.affection??e.delta_affection);null!==n&&(i.deltas.affection[t]=n)}if(o.has("trust")){const n=p(a?.trust??e.delta_trust);null!==n&&(i.deltas.trust[t]=n)}if(o.has("desire")){const n=p(a?.desire??e.delta_desire);null!==n&&(i.deltas.desire[t]=n)}if(o.has("connection")){const n=p(a?.connection??e.delta_connection);null!==n&&(i.deltas.connection[t]=n)}if(o.has("mood")){const n=c(e.mood);null!==n&&(i.mood[t]=n)}if(o.has("lastThought")){const n=c(e.lastThought);null!==n&&(i.lastThought[t]=n)}}return i}const d=["Happy","Sad","Angry","Excited","Confused","In Love","Shy","Playful","Serious","Lonely","Hopeful","Anxious","Content","Frustrated","Neutral"];function u(t){return Object.keys(t).length>0}function g(t,e){for(const n of e){if("affection"===n&&u(t.deltas.affection))return!0;if("trust"===n&&u(t.deltas.trust))return!0;if("desire"===n&&u(t.deltas.desire))return!0;if("connection"===n&&u(t.deltas.connection))return!0;if("mood"===n&&u(t.mood))return!0;if("lastThought"===n&&u(t.lastThought))return!0}return!1}function p(t){return["SYSTEM OVERRIDE:","Return ONLY valid JSON.","No prose. No roleplay. No markdown except optional ```json fences.","If uncertain, still return best-effort JSON with required keys.","",t].join("\n")}function f(t){return Object.keys(t).length}const h="bst_relationship_state";let m="";function b(t){const e=Number(t);return Number.isNaN(e)?null:function(t){return Math.max(0,Math.min(100,Math.round(t)))}(e)}async function x(){try{const t=Function("return import('/script.js')");return await t()}catch{return null}}function y(){return m}const v="bst-extension-settings-panel",k=["#extensions_settings2","#extensions_settings","#extensions-menu .extensions_settings","#extensions-menu"];const S={enabled:!0,maxConcurrentCalls:2,contextMessages:10,connectionProfile:"",injectTrackerIntoPrompt:!0,sequentialExtraction:!1,maxDeltaPerTurn:15,confidenceDampening:.65,moodStickiness:.6,strictJsonRepair:!0,maxRetriesPerStat:2,showLastThought:!0,showInactive:!0,inactiveLabel:"Off-screen",autoDetectActive:!0,activityLookback:5,trackAffection:!0,trackTrust:!0,trackDesire:!0,trackConnection:!0,trackMood:!0,trackLastThought:!0,accentColor:"#ff5a6f",cardOpacity:.92,borderRadius:14,fontSize:14,defaultAffection:50,defaultTrust:50,defaultDesire:50,defaultConnection:50,defaultMood:"Neutral",debug:!1,includeContextInDiagnostics:!1,includeGraphInDiagnostics:!0};function w(t,e){const n=A(e);t.extensionSettings||(t.extensionSettings={}),t.extensionSettings[a]=n,t.saveSettingsDebounced?.(),function(t){try{localStorage.setItem(M,JSON.stringify(t))}catch{}}(n),async function(t){try{const e=Function("return import('/scripts/extensions.js')"),n=await e();if(!n.extension_settings)return;n.extension_settings[a]=t,n.saveSettingsDebounced?.()}catch{}}(n)}function I(t,...e){t.debug&&console.log("[BetterSimTracker]",...e)}const M=`extension-settings:${a}`;function T(t){if(!t||"object"!=typeof t)return null;const e=t,n=String(e.id??e.profileId??e.value??e.profile??"").trim();return n?{id:n,label:String(e.name??e.label??e.displayName??e.title??n).trim()||n}:null}function C(t){return Array.isArray(t)?t.map(T).filter(t=>Boolean(t)):[]}function D(t){const e=[],n=t.extensionSettings,a=n?.connectionManager;e.push(a?.profiles);const s=t.chatCompletionSettings;s&&e.push(s.profiles,s.profileList,s.connections);const o=globalThis,r=o.extension_settings,i=r?.connectionManager;e.push(i?.profiles,o.chat_completion_profiles,o.chatCompletionProfiles,o.power_user?.chat_completion_profiles,o.power_user?.chatCompletionProfiles);const c=new Map;for(const t of e)for(const e of C(t))c.has(e.id)||c.set(e.id,e);if(0===c.size)for(const t of function(){try{const t=["chat_completion_profiles","chatCompletionProfiles","power_user.chat_completion_profiles"];for(const e of t){const t=localStorage.getItem(e);if(!t)continue;const n=C(JSON.parse(t));if(n.length)return n}}catch{}return[]}())c.has(t.id)||c.set(t.id,t);const l=String(a?.selectedProfile??i?.selectedProfile??"").trim();return l&&!c.has(l)&&c.set(l,{id:l,label:`${l} (selected)`}),Array.from(c.values())}function E(t,e,n,a){const s=Number(t);return Number.isNaN(s)?e:Math.max(n,Math.min(a,s))}function N(t,e,n,a){return Math.round(E(t,e,n,a))}function _(t,e){return"boolean"==typeof t?t:e}function $(t,e){return"string"!=typeof t?e:t.trim()||e}function A(t){return{...S,...t,enabled:_(t.enabled,S.enabled),maxConcurrentCalls:N(t.maxConcurrentCalls,S.maxConcurrentCalls,1,8),contextMessages:N(t.contextMessages,S.contextMessages,1,40),connectionProfile:"string"==typeof t.connectionProfile?t.connectionProfile.trim():S.connectionProfile,injectTrackerIntoPrompt:_(t.injectTrackerIntoPrompt,S.injectTrackerIntoPrompt),sequentialExtraction:_(t.sequentialExtraction,S.sequentialExtraction),maxDeltaPerTurn:N(t.maxDeltaPerTurn,S.maxDeltaPerTurn,1,30),confidenceDampening:E(t.confidenceDampening,S.confidenceDampening,0,1),moodStickiness:E(t.moodStickiness,S.moodStickiness,0,1),strictJsonRepair:_(t.strictJsonRepair,S.strictJsonRepair),maxRetriesPerStat:N(t.maxRetriesPerStat,S.maxRetriesPerStat,0,4),showLastThought:_(t.showLastThought,S.showLastThought),showInactive:_(t.showInactive,S.showInactive),inactiveLabel:$(t.inactiveLabel,S.inactiveLabel).slice(0,40),autoDetectActive:_(t.autoDetectActive,S.autoDetectActive),activityLookback:N(t.activityLookback,S.activityLookback,1,25),trackAffection:_(t.trackAffection,S.trackAffection),trackTrust:_(t.trackTrust,S.trackTrust),trackDesire:_(t.trackDesire,S.trackDesire),trackConnection:_(t.trackConnection,S.trackConnection),trackMood:_(t.trackMood,S.trackMood),trackLastThought:_(t.trackLastThought,S.trackLastThought),accentColor:$(t.accentColor,S.accentColor),cardOpacity:E(t.cardOpacity,S.cardOpacity,.1,1),borderRadius:N(t.borderRadius,S.borderRadius,0,32),fontSize:N(t.fontSize,S.fontSize,10,22),defaultAffection:N(t.defaultAffection,S.defaultAffection,0,100),defaultTrust:N(t.defaultTrust,S.defaultTrust,0,100),defaultDesire:N(t.defaultDesire,S.defaultDesire,0,100),defaultConnection:N(t.defaultConnection,S.defaultConnection,0,100),defaultMood:$(t.defaultMood,S.defaultMood).slice(0,80),debug:_(t.debug,S.debug),includeContextInDiagnostics:_(t.includeContextInDiagnostics,S.includeContextInDiagnostics),includeGraphInDiagnostics:_(t.includeGraphInDiagnostics,S.includeGraphInDiagnostics)}}const L=`${a}:chat`;function P(t){const e=t.extra?.[a],n=function(t,e){if(!e||"object"!=typeof e)return null;if(j(e))return e;const n=e,a=Number(t.swipe_id??0),s=n[String(Number.isNaN(a)?0:a)];if(j(s))return s;const o=n[0];if(j(o))return o;for(const t of Object.values(n))if(j(t))return t;return null}(t,e);return n?R(n):null}function R(t){return{timestamp:Number(t.timestamp??Date.now()),activeCharacters:Array.isArray(t.activeCharacters)?t.activeCharacters:[],statistics:{affection:{},trust:{},desire:{},connection:{},mood:{},lastThought:{},...t.statistics}}}function j(t){if(!t||"object"!=typeof t)return!1;const e=t;return!(!e.statistics||!e.activeCharacters)}function O(t){for(let e=t.chat.length-1;e>=0;e-=1){const n=P(t.chat[e]);if(n)return{data:n,messageIndex:e}}return null}function q(t){const e=t;return`${String(e.chatId??e.chat_id??"").trim()||"nochat"}|${t.groupId?`group:${t.groupId}`:`char:${String(t.characterId??"unknown")}`}`}const z=`${a}:latestByScope`;function G(t){if(!t||"object"!=typeof t)return{history:[]};const e=t;return Array.isArray(e.history)?{latest:e.latest,history:e.history}:{latest:e.latest,history:[]}}function B(t){return`${a}:history:${q(t)}`}function H(){try{const t=localStorage.getItem(z);if(!t)return{};const e=JSON.parse(t);return e&&"object"==typeof e?e:{}}catch{return{}}}function J(t){try{localStorage.setItem(z,JSON.stringify(t))}catch{}}function F(t){const e=B(t);try{const t=localStorage.getItem(e);return t?G(JSON.parse(t)):{history:[]}}catch{return{history:[]}}}function U(t){try{const e=t.chatMetadata?.[a];return G(e)}catch{return{history:[]}}}function Y(t){const e=t.chat?.[0];return e?.extra?G(e.extra[L]):{history:[]}}function W(t,e){const n=[];for(let a=t.chat.length-1;a>=0&&n.length<e;a-=1){const e=P(t.chat[a]);e&&n.push(e)}if(n.length>=e)return n.slice(0,e);const a=F(t),s=U(t),o=Y(t),r=new Set(n.map(t=>t.timestamp)),i=[...o.history,...s.history,...a.history];for(const t of i){if(n.length>=e)break;t?.data&&!r.has(t.data.timestamp)&&(n.push(t.data),r.add(t.data.timestamp))}return n.slice(0,e)}function X(t,e,n){if(n<0||n>=t.chat.length)return;const s=t.chat[n];s.extra||(s.extra={});const o=Number(s.swipe_id??0),r=String(Number.isNaN(o)?0:o),i=s.extra[a],c={};if(i&&"object"==typeof i)if(j(i))c[0]=R(i);else for(const[t,e]of Object.entries(i))j(e)&&(c[t]=R(e));c[r]=e,s.extra[a]=c,function(t,e,n){const s=Date.now(),o=t=>({...t,latest:{data:e,messageIndex:n,timestamp:s},history:[{data:e,timestamp:s},...t.history.filter(t=>t.data.timestamp!==e.timestamp)].slice(0,30)});!function(t,e){const n=B(t);try{localStorage.setItem(n,JSON.stringify(e))}catch{}}(t,o(F(t))),function(t,e){try{t.chatMetadata||(t.chatMetadata={}),t.chatMetadata[a]=e,t.saveMetadataDebounced?.()}catch{}}(t,o(U(t))),function(t,e){const n=t.chat?.[0];n&&(n.extra||(n.extra={}),n.extra[L]=e)}(t,o(Y(t)));const r=q(t),i=H();i[r]={data:e,messageIndex:n,timestamp:s},J(i)}(t,e,n)}const V=[{key:"affection",label:"Affection"},{key:"trust",label:"Trust"},{key:"desire",label:"Desire"},{key:"connection",label:"Connection"}];function Q(t,e){return"affection"===t?e.defaultAffection:"trust"===t?e.defaultTrust:"desire"===t?e.defaultDesire:e.defaultConnection}const K="bst-root",Z=new Set;function tt(t){if("number"==typeof t)return Math.max(0,Math.min(100,t));const e=Number(t);return Number.isNaN(e)?0:Math.max(0,Math.min(100,e))}function et(t){return t.trim().toLowerCase()}function nt(t){const e=t.toLowerCase();return e.includes("happy")||e.includes("excited")?"&#x1F604;":e.includes("content")?"&#x1F642;":e.includes("hopeful")?"&#x1F91E;":e.includes("playful")?"&#x1F60F;":e.includes("serious")?"&#x1F610;":e.includes("shy")?"&#x1F60A;":e.includes("in love")?"&#x1F60D;":e.includes("anxious")?"&#x1F61F;":e.includes("confused")?"&#x1F615;":e.includes("angry")?"&#x1F620;":e.includes("frustrated")?"&#x1F624;":e.includes("sad")||e.includes("lonely")?"&#x1F614;":"&#x1F636;"}function at(t){const e=t.toLowerCase();return e.includes("happy")||e.includes("excited")||e.includes("in love")?"rgba(87, 214, 138, 0.25)":e.includes("content")||e.includes("hopeful")||e.includes("playful")?"rgba(89, 185, 255, 0.24)":e.includes("frustrated")||e.includes("angry")||e.includes("sad")||e.includes("lonely")?"rgba(255, 120, 136, 0.25)":"rgba(255,255,255,0.12)"}function st(t){return t>0?`+${t}`:t<0?`${t}`:"0"}function ot(t){let e=0;const n=t.trim().toLowerCase();for(let t=0;t<n.length;t+=1)e=31*e+n.charCodeAt(t)>>>0;return`hsl(${e%360} ${46+e%22}% ${24+(e>>5)%10}%)`}function rt(t){let e=0;const n=t.trim().toLowerCase();for(let t=0;t<n.length;t+=1)e=31*e+n.charCodeAt(t)>>>0;return{h:e%360,s:46+e%22,l:24+(e>>5)%10}}function it(t,e){const n=Math.abs(t-e)%360;return n>180?360-n:n}function ct(){if(document.getElementById(s))return;const t=document.createElement("style");t.id=s,t.textContent=`\n.${K} {\n  margin-top: 10px;\n  display: grid;\n  gap: 8px;\n  pointer-events: auto;\n}\n.bst-loading {\n  border: 1px solid rgba(255,255,255,0.16);\n  background: linear-gradient(180deg, rgba(23, 27, 38, 0.95), rgba(15, 18, 26, 0.95));\n  border-radius: 12px;\n  color: #f3f5f9;\n  padding: 10px;\n}\n.bst-loading-row {\n  display: flex;\n  justify-content: space-between;\n  font-size: 12px;\n  margin-bottom: 6px;\n}\n.bst-loading-sub {\n  margin-top: 6px;\n  font-size: 11px;\n  opacity: 0.82;\n}\n.bst-loading-track {\n  height: 8px;\n  border-radius: 999px;\n  background: rgba(255,255,255,0.14);\n  overflow: hidden;\n}\n.bst-loading-fill {\n  height: 100%;\n  width: 0%;\n  background: linear-gradient(90deg, var(--bst-accent), #ffd38f);\n  transition: width 0.25s ease;\n}\n.bst-loading-track-indeterminate .bst-loading-fill {\n  width: 42%;\n  animation: bst-indeterminate-slide 1.1s ease-in-out infinite;\n}\n@keyframes bst-indeterminate-slide {\n  0% { transform: translateX(-100%); }\n  50% { transform: translateX(30%); }\n  100% { transform: translateX(230%); }\n}\n.bst-root-actions {\n  display: flex;\n  justify-content: flex-end;\n  gap: 6px;\n  margin-bottom: 2px;\n}\n.bst-card {\n  position: relative;\n  overflow: hidden;\n  background: linear-gradient(165deg, color-mix(in srgb, var(--bst-card-local, var(--bst-card)) 88%, #ffffff 12%), color-mix(in srgb, var(--bst-card-local, var(--bst-card)) 72%, #000 28%));\n  border: 1px solid color-mix(in srgb, var(--bst-card-local, var(--bst-accent)) 46%, #ffffff 54%);\n  border-radius: var(--bst-radius);\n  color: #fff;\n  box-shadow: 0 8px 20px rgba(0,0,0,0.22), 0 0 0 1px rgba(255,255,255,0.06) inset;\n  padding: 11px 12px;\n}\n.bst-card-inactive {\n  border-color: rgba(255,255,255,0.12);\n  box-shadow: 0 4px 12px rgba(0,0,0,0.30), 0 0 0 1px rgba(255,255,255,0.03) inset;\n}\n.bst-card-inactive::after {\n  content: "";\n  position: absolute;\n  inset: 0;\n  background: rgba(5, 7, 12, 0.43);\n  pointer-events: none;\n}\n.bst-card-inactive .bst-state {\n  background: rgba(0,0,0,0.45);\n}\n.bst-head {\n  display: flex;\n  align-items: baseline;\n  justify-content: space-between;\n  margin-bottom: 7px;\n}\n.bst-name {\n  font-weight: 700;\n  letter-spacing: 0.2px;\n}\n.bst-state {\n  font-size: 12px;\n  padding: 2px 8px;\n  border-radius: 999px;\n  background: rgba(255,255,255,0.14);\n}\n.bst-actions {\n  display: flex;\n  gap: 6px;\n  align-items: center;\n}\n.bst-mini-btn {\n  border: 1px solid rgba(255,255,255,0.22);\n  border-radius: 7px;\n  padding: 2px 6px;\n  background: rgba(16,21,32,0.8);\n  color: #fff;\n  font-size: 11px;\n  cursor: pointer;\n  transition: border-color .16s ease, background-color .16s ease, transform .1s ease;\n}\n.bst-mini-btn:hover {\n  border-color: rgba(255,255,255,0.42);\n  background: rgba(22,28,42,0.92);\n}\n.bst-mini-btn:active {\n  transform: translateY(1px);\n}\n.bst-mini-btn-icon {\n  width: 24px;\n  min-width: 24px;\n  height: 24px;\n  padding: 0;\n  font-size: 14px;\n  line-height: 1;\n  text-align: center;\n}\n.bst-mini-btn-accent {\n  border-color: color-mix(in srgb, var(--bst-accent) 55%, #ffffff 45%);\n  background: color-mix(in srgb, var(--bst-accent) 22%, #131a28 78%);\n}\n.bst-mini-btn-accent:hover {\n  border-color: color-mix(in srgb, var(--bst-accent) 78%, #ffffff 22%);\n  background: color-mix(in srgb, var(--bst-accent) 33%, #131a28 67%);\n}\n.bst-row { margin: 7px 0; }\n.bst-label {\n  display: flex;\n  justify-content: space-between;\n  font-size: 12px;\n  margin-bottom: 3px;\n  opacity: 0.93;\n}\n.bst-track {\n  background: rgba(255,255,255,0.14);\n  height: 8px;\n  border-radius: 999px;\n  overflow: hidden;\n}\n.bst-fill {\n  height: 100%;\n  background: linear-gradient(90deg, var(--bst-accent), color-mix(in srgb, var(--bst-accent) 65%, #ffd38f 35%));\n  box-shadow: 0 0 10px color-mix(in srgb, var(--bst-accent) 70%, #ffffff 30%);\n  transition: width 0.5s ease;\n}\n.bst-mood { margin-top: 7px; }\n.bst-mood-emoji { font-size: 18px; line-height: 1; }\n.bst-mood-wrap {\n  display: inline-flex;\n  align-items: center;\n  gap: 6px;\n}\n.bst-mood-badge {\n  font-size: 11px;\n  padding: 2px 8px;\n  border-radius: 999px;\n  border: 1px solid rgba(255,255,255,0.22);\n  background: rgba(255,255,255,0.10);\n}\n.bst-delta {\n  font-size: 10px;\n  margin-left: 6px;\n  opacity: 0.9;\n}\n.bst-delta-up { color: #94f7a8; }\n.bst-delta-down { color: #ff9ea8; }\n.bst-delta-flat { color: #d4d9e8; }\n.bst-thought {\n  margin-top: 8px;\n  font-size: 12px;\n  line-height: 1.35;\n  padding: 8px;\n  border-radius: 10px;\n  background: rgba(0,0,0,0.18);\n  font-style: italic;\n}\n.bst-root-collapsed .bst-body {\n  display: none;\n}\n.bst-collapsed-summary {\n  display: none;\n  margin-top: 6px;\n  font-size: 11px;\n  opacity: 0.92;\n  align-items: center;\n  gap: 8px;\n}\n.bst-root-collapsed .bst-collapsed-summary {\n  display: flex;\n}\n.bst-collapsed-mood {\n  display: inline-flex;\n  align-items: center;\n  justify-content: center;\n  min-width: 18px;\n  font-size: 14px;\n}\n.bst-settings-backdrop {\n  position: fixed;\n  inset: 0;\n  background: rgba(0,0,0,0.46);\n  z-index: 2147483000;\n  pointer-events: auto;\n}\n.bst-settings {\n  position: fixed;\n  z-index: 2147483001;\n  left: 50%;\n  top: 50%;\n  transform: translate(-50%, -50%);\n  width: min(760px, calc(100vw - 16px));\n  max-height: calc(100dvh - 16px);\n  background:\n    radial-gradient(1200px 400px at 0% 0%, rgba(255, 98, 123, 0.14), transparent 60%),\n    radial-gradient(900px 300px at 100% 0%, rgba(86, 189, 255, 0.12), transparent 55%),\n    #121621;\n  border: 1px solid rgba(255,255,255,0.16);\n  border-radius: 16px;\n  color: #fff;\n  padding: 16px;\n  pointer-events: auto;\n  overflow-y: auto;\n  overscroll-behavior: contain;\n  font-family: "Segoe UI", "Trebuchet MS", sans-serif;\n  box-shadow: 0 24px 80px rgba(0,0,0,0.5);\n}\n.bst-settings h3 { margin: 0 0 4px 0; font-size: 20px; letter-spacing: 0.2px; }\n.bst-settings-top {\n  display: flex;\n  justify-content: space-between;\n  align-items: flex-start;\n  gap: 10px;\n}\n.bst-settings-subtitle { margin: 0 0 12px 0; opacity: 0.78; font-size: 12px; }\n.bst-settings-grid { display: grid; gap: 10px; grid-template-columns: repeat(2, minmax(0, 1fr)); }\n.bst-settings label { font-size: 12px; display: flex; flex-direction: column; gap: 4px; }\n.bst-check { flex-direction: row !important; align-items: center; gap: 8px !important; }\n.bst-check input[type="checkbox"] { width: 16px; height: 16px; accent-color: var(--bst-accent); }\n.bst-settings input, .bst-settings select {\n  background: #0d1220 !important;\n  color: #f3f5f9 !important;\n  border: 1px solid rgba(255,255,255,0.20) !important;\n  border-radius: 8px;\n  padding: 7px;\n}\n.bst-settings input::placeholder { color: rgba(243,245,249,0.6); }\n.bst-settings-section {\n  margin: 12px 0;\n  padding: 12px;\n  border-radius: 12px;\n  border: 1px solid rgba(255,255,255,0.12);\n  background: rgba(9, 12, 20, 0.45);\n}\n.bst-settings-section h4 {\n  margin: 0 0 10px 0;\n  font-size: 13px;\n  font-weight: 700;\n  letter-spacing: 0.4px;\n  text-transform: uppercase;\n  opacity: 0.9;\n}\n.bst-help-list {\n  margin: 0;\n  padding-left: 16px;\n  display: grid;\n  gap: 4px;\n  font-size: 12px;\n  opacity: 0.92;\n}\n.bst-help-line {\n  font-size: 12px;\n  opacity: 0.9;\n}\n.bst-btn {\n  border: 1px solid rgba(255,255,255,0.2);\n  border-radius: 8px;\n  padding: 7px 10px;\n  color: #fff;\n  background: #23293a;\n  cursor: pointer;\n}\n.bst-close-btn {\n  min-width: 36px;\n  width: 36px;\n  height: 36px;\n  padding: 0;\n  display: inline-flex;\n  align-items: center;\n  justify-content: center;\n  font-size: 18px;\n  line-height: 1;\n}\n.bst-btn-icon {\n  display: inline-flex;\n  align-items: center;\n  justify-content: center;\n  width: 34px;\n  min-width: 34px;\n  height: 34px;\n  padding: 0;\n  font-size: 16px;\n  line-height: 1;\n}\n.bst-btn-soft {\n  border-color: color-mix(in srgb, var(--bst-accent) 45%, #ffffff 55%);\n  background: color-mix(in srgb, var(--bst-accent) 16%, #1e2738 84%);\n}\n.bst-btn-danger {\n  border-color: #d06a6a;\n  color: #ffd2d2;\n  background: #3a2020;\n}\n.bst-debug-actions {\n  margin-top: 10px;\n  display: flex;\n  flex-wrap: wrap;\n  gap: 8px;\n  align-items: center;\n}\n.bst-debug-box {\n  margin-top: 8px;\n  background: #0b1020;\n  border: 1px solid rgba(255,255,255,0.14);\n  border-radius: 8px;\n  padding: 8px;\n  max-height: 220px;\n  overflow: auto;\n  font-family: Consolas, "Courier New", monospace;\n  font-size: 11px;\n  white-space: pre-wrap;\n}\n.bst-graph-backdrop {\n  position: fixed;\n  inset: 0;\n  background: rgba(0,0,0,0.5);\n  z-index: 2147483010;\n}\n.bst-graph-modal {\n  position: fixed;\n  z-index: 2147483011;\n  left: 50%;\n  top: 50%;\n  transform: translate(-50%, -50%);\n  width: min(860px, calc(100vw - 16px));\n  max-height: calc(100dvh - 16px);\n  overflow: auto;\n  background: #121621;\n  border: 1px solid rgba(255,255,255,0.16);\n  border-radius: 16px;\n  padding: 14px;\n  color: #fff;\n}\n.bst-graph-top {\n  display: flex;\n  justify-content: space-between;\n  align-items: center;\n  margin-bottom: 10px;\n}\n.bst-graph-title {\n  font-size: 15px;\n  font-weight: 700;\n}\n.bst-graph-controls {\n  display: flex;\n  justify-content: flex-start;\n  flex-wrap: wrap;\n  gap: 8px 12px;\n  margin-bottom: 8px;\n}\n.bst-graph-window-select {\n  background: #0d1220;\n  color: #f3f5f9;\n  border: 1px solid rgba(255,255,255,.2);\n  border-radius: 8px;\n  padding: 4px 6px;\n}\n.bst-graph-svg {\n  width: 100%;\n  height: 320px;\n  border: 1px solid rgba(255,255,255,0.12);\n  border-radius: 10px;\n  background: #0d1220;\n}\n.bst-graph-toggle {\n  display: inline-flex;\n  align-items: center;\n  gap: 8px;\n  font-size: 12px;\n  opacity: 0.92;\n  user-select: none;\n}\n.bst-graph-toggle input {\n  display: none;\n}\n.bst-graph-toggle-switch {\n  position: relative;\n  width: 36px;\n  height: 20px;\n  border-radius: 999px;\n  background: rgba(255,255,255,0.2);\n  border: 1px solid rgba(255,255,255,0.32);\n  transition: background .18s ease, border-color .18s ease;\n}\n.bst-graph-toggle-switch::after {\n  content: "";\n  position: absolute;\n  top: 2px;\n  left: 2px;\n  width: 14px;\n  height: 14px;\n  border-radius: 999px;\n  background: #fff;\n  transition: transform .18s ease;\n}\n.bst-graph-toggle input:checked + .bst-graph-toggle-switch {\n  background: color-mix(in srgb, var(--bst-accent) 60%, #22314d 40%);\n  border-color: color-mix(in srgb, var(--bst-accent) 72%, #ffffff 28%);\n}\n.bst-graph-toggle input:checked + .bst-graph-toggle-switch::after {\n  transform: translateX(16px);\n}\n.bst-graph-legend {\n  display: flex;\n  gap: 10px;\n  margin-top: 8px;\n  font-size: 11px;\n  flex-wrap: wrap;\n}\n.bst-graph-legend span {\n  display: inline-flex;\n  align-items: center;\n  gap: 5px;\n}\n.bst-legend-dot {\n  width: 9px;\n  height: 9px;\n  border-radius: 999px;\n  display: inline-block;\n}\n@media (max-width: 820px) {\n  .bst-mini-btn {\n    min-height: 30px;\n    padding: 4px 8px;\n    font-size: 12px;\n  }\n  .bst-settings {\n    left: 0;\n    top: 0;\n    transform: none;\n    width: 100vw;\n    height: 100dvh;\n    max-height: 100dvh;\n    border-radius: 0;\n    border-left: 0;\n    border-right: 0;\n    padding: 12px 10px 18px;\n  }\n  .bst-settings h3 {\n    font-size: 18px;\n  }\n  .bst-close-btn {\n    min-width: 40px;\n    width: 40px;\n    height: 40px;\n    font-size: 20px;\n  }\n  .bst-settings-grid {\n    grid-template-columns: minmax(0, 1fr);\n    gap: 12px;\n  }\n  .bst-settings label {\n    font-size: 13px;\n  }\n  .bst-help-list,\n  .bst-help-line {\n    font-size: 13px;\n  }\n  .bst-settings input,\n  .bst-settings select {\n    font-size: 16px;\n    padding: 9px 10px;\n  }\n  .bst-btn {\n    min-height: 40px;\n    font-size: 13px;\n  }\n  .bst-btn-icon {\n    min-height: 40px;\n    width: 40px;\n    min-width: 40px;\n  }\n  .bst-debug-actions {\n    display: grid;\n    grid-template-columns: minmax(0, 1fr);\n  }\n  .bst-graph-modal {\n    left: 0;\n    top: 0;\n    transform: none;\n    width: 100vw;\n    height: 100dvh;\n    max-height: 100dvh;\n    border-radius: 0;\n    border-left: 0;\n    border-right: 0;\n    padding: 10px;\n  }\n  .bst-graph-top {\n    align-items: center;\n    gap: 8px;\n  }\n  .bst-graph-title {\n    font-size: 14px;\n  }\n  .bst-graph-controls {\n    flex-direction: column;\n    align-items: flex-start;\n    gap: 10px;\n  }\n  .bst-graph-window-select {\n    font-size: 16px;\n    padding: 6px 8px;\n  }\n  .bst-graph-svg {\n    height: 250px;\n  }\n}\n`,document.head.appendChild(t)}function lt(t){const e=function(t){if(null==t)return null;const e=[`.mes[mesid="${t}"]`,`.mes[data-mesid="${t}"]`,`[mesid="${t}"]`,`[data-mesid="${t}"]`];for(const t of e){const e=document.querySelector(t);if(e instanceof HTMLElement)return e}return null}(t);if(!e)return null;const n=String(t);let a=document.querySelector(`.${K}[data-message-index="${n}"]`);a||(a=document.createElement("div"),a.className=K,a.dataset.messageIndex=n);const s=e.querySelector(".mes_block")??e.querySelector(".mes_text")??e;return a.parentElement!==s&&s.appendChild(a),a}function dt(t,e,n){let a=50;return t.map(t=>{const s=t.statistics[n]?.[e];if(void 0!==s){const t=Number(s);Number.isNaN(t)||(a=Math.max(0,Math.min(100,t)))}return a})}function ut(t,e=3){if(t.length<=2||e<=1)return t;const n=Math.floor(e/2);return t.map((e,a)=>{let s=0,o=0;for(let e=a-n;e<=a+n;e+=1)e<0||e>=t.length||(s+=t[e],o+=1);return 0===o?t[a]:s/o})}const gt="bst-graph-smoothing",pt="bst-graph-window";function ft(t,e,n,a=24){if(!t.length)return"";const s=Math.max(1,e-2*a),o=Math.max(1,n-2*a);return t.map((e,n)=>`${a+(1===t.length?s/2:s*n/(t.length-1))},${a+(100-e)/100*o}`).join(" ")}function ht(t,e,n,a,s,o=24){if(!t.length)return"";const r=Math.max(1,a-2*o),i=Math.max(1,s-2*o);return t.map((n,a)=>`<circle cx="${o+(1===t.length?r/2:r*a/(t.length-1))}" cy="${o+(100-n)/100*i}" r="2.7" fill="${e}" />`).join("")}function mt(t){ct(),bt();const e=document.createElement("div");e.className="bst-graph-backdrop",e.addEventListener("click",()=>bt()),document.body.appendChild(e);const n=document.createElement("div");n.className="bst-graph-modal";const a=[...t.history].filter(t=>Number.isFinite(t.timestamp)).sort((t,e)=>t.timestamp-e.timestamp).filter(e=>{return n=e,a=t.character,void 0!==n.statistics.affection?.[a]||void 0!==n.statistics.trust?.[a]||void 0!==n.statistics.desire?.[a]||void 0!==n.statistics.connection?.[a]||void 0!==n.statistics.mood?.[a]||void 0!==n.statistics.lastThought?.[a];var n,a}),s=a.length,o=function(){try{const t=String(localStorage.getItem(pt)??"all");if("30"===t||"60"===t||"120"===t||"all"===t)return t}catch{}return"all"}(),r="all"===o?null:Number(o),i=function(t,e=140){if(t.length<=e)return t;return function(t,e){if(t<=e)return Array.from({length:t},(t,e)=>e);const n=new Set([0,t-1]),a=(t-1)/(e-1);for(let t=1;t<e-1;t+=1)n.add(Math.round(t*a));return Array.from(n).sort((t,e)=>t-e)}(t.length,e).map(e=>t[e])}(r?a.slice(-r):a,140),c={affection:dt(i,t.character,"affection"),trust:dt(i,t.character,"trust"),desire:dt(i,t.character,"desire"),connection:dt(i,t.character,"connection")},l=780,d=320;let u=function(){try{return"1"===localStorage.getItem(gt)}catch{return!1}}();const g={affection:u?ut(c.affection,3):c.affection,trust:u?ut(c.trust,3):c.trust,desire:u?ut(c.desire,3):c.desire,connection:u?ut(c.connection,3):c.connection},p=ft(g.affection,l,d),f=ft(g.trust,l,d),h=ft(g.desire,l,d),m=ft(g.connection,l,d),b=ht(c.affection,"#ff6b81",0,l,d),x=ht(c.trust,"#55d5ff",0,l,d),y=ht(c.desire,"#ffb347",0,l,d),v=t.accentColor||"#9cff8f",k=ht(c.connection,v,0,l,d),S={affection:c.affection.at(-1)??0,trust:c.trust.at(-1)??0,desire:c.desire.at(-1)??0,connection:c.connection.at(-1)??0},w=i.length;t.debug&&console.log("[BetterSimTracker] graph-open",{character:t.character,snapshotCount:w,rawSnapshotCount:s,windowPreference:o,latest:S}),n.innerHTML=`\n    <div class="bst-graph-top">\n      <div class="bst-graph-title">${t.character} Relationship Trend</div>\n      <button class="bst-btn bst-close-btn" data-action="close" title="Close graph" aria-label="Close graph">&times;</button>\n    </div>\n    <div class="bst-graph-controls">\n      <label class="bst-graph-toggle" title="Display history range">\n        <span>History</span>\n        <select class="bst-graph-window-select" data-action="window">\n          <option value="30" ${"30"===o?"selected":""}>30</option>\n          <option value="60" ${"60"===o?"selected":""}>60</option>\n          <option value="120" ${"120"===o?"selected":""}>120</option>\n          <option value="all" ${"all"===o?"selected":""}>All</option>\n        </select>\n      </label>\n      <label class="bst-graph-toggle" title="Toggle smoothed graph lines">\n        <input type="checkbox" data-action="toggle-smoothing" ${u?"checked":""}>\n        <span class="bst-graph-toggle-switch"></span>\n        <span>Smoothed</span>\n      </label>\n    </div>\n    <svg class="bst-graph-svg" viewBox="0 0 780 320" width="100%" height="320">\n      <line x1="24" y1="228" x2="756" y2="228" stroke="rgba(255,255,255,0.11)" stroke-width="1"></line>\n      <line x1="24" y1="160" x2="756" y2="160" stroke="rgba(255,255,255,0.11)" stroke-width="1"></line>\n      <line x1="24" y1="92" x2="756" y2="92" stroke="rgba(255,255,255,0.11)" stroke-width="1"></line>\n      <line x1="24" y1="296" x2="756" y2="296" stroke="rgba(255,255,255,0.25)" stroke-width="1"></line>\n      <line x1="24" y1="24" x2="24" y2="296" stroke="rgba(255,255,255,0.25)" stroke-width="1"></line>\n      <text x="8" y="296" fill="rgba(255,255,255,0.75)" font-size="10">0</text>\n      <text x="4" y="228" fill="rgba(255,255,255,0.75)" font-size="10">25</text>\n      <text x="4" y="160" fill="rgba(255,255,255,0.75)" font-size="10">50</text>\n      <text x="4" y="92" fill="rgba(255,255,255,0.75)" font-size="10">75</text>\n      <text x="2" y="28" fill="rgba(255,255,255,0.75)" font-size="10">100</text>\n      <text x="756" y="14" fill="rgba(255,255,255,0.72)" font-size="10" text-anchor="end">Y: Relationship %</text>\n      <text x="24" y="312" fill="rgba(255,255,255,0.72)" font-size="10">1</text>\n      <text x="${Math.round(390)}" y="312" fill="rgba(255,255,255,0.72)" font-size="10" text-anchor="middle">${Math.max(1,Math.ceil(w/2))}</text>\n      <text x="756" y="312" fill="rgba(255,255,255,0.72)" font-size="10" text-anchor="end">${Math.max(1,w)}</text>\n      <text x="756" y="26" fill="rgba(255,255,255,0.72)" font-size="10" text-anchor="end">X: Chat Timeline</text>\n      <polyline points="${p}" fill="none" stroke="#ff6b81" stroke-width="2.5"></polyline>\n      <polyline points="${f}" fill="none" stroke="#55d5ff" stroke-width="2.5"></polyline>\n      <polyline points="${h}" fill="none" stroke="#ffb347" stroke-width="2.5"></polyline>\n      <polyline points="${m}" fill="none" stroke="${v}" stroke-width="2.5"></polyline>\n      ${b}\n      ${x}\n      ${y}\n      ${k}\n      ${0===w?`<text x="${Math.round(390)}" y="${Math.round(160)}" fill="rgba(255,255,255,0.65)" font-size="13" text-anchor="middle">No tracker history yet</text>`:""}\n    </svg>\n    <div class="bst-graph-legend">\n      <span><i class="bst-legend-dot" style="background:#ff6b81;"></i>Affection ${Math.round(S.affection)}</span>\n      <span><i class="bst-legend-dot" style="background:#55d5ff;"></i>Trust ${Math.round(S.trust)}</span>\n      <span><i class="bst-legend-dot" style="background:#ffb347;"></i>Desire ${Math.round(S.desire)}</span>\n      <span><i class="bst-legend-dot" style="background:${v};"></i>Connection ${Math.round(S.connection)}</span>\n    </div>\n  `,document.body.appendChild(n),n.querySelector('[data-action="close"]')?.addEventListener("click",()=>bt()),n.querySelector('[data-action="toggle-smoothing"]')?.addEventListener("change",e=>{const n=e.currentTarget;!function(t){try{localStorage.setItem(gt,t?"1":"0")}catch{}}(Boolean(n.checked)),bt(),mt(t)}),n.querySelector('[data-action="window"]')?.addEventListener("change",e=>{const n=e.currentTarget;!function(t){try{localStorage.setItem(pt,t)}catch{}}("30"===n.value||"60"===n.value||"120"===n.value||"all"===n.value?n.value:"all"),bt(),mt(t)})}function bt(){document.querySelector(".bst-graph-backdrop")?.remove(),document.querySelector(".bst-graph-modal")?.remove()}function xt(){document.querySelector(".bst-settings-backdrop")?.remove(),document.querySelector(".bst-settings")?.remove()}let yt=null,vt=!1,kt=0,St=[],wt=null,It=null,Mt={phase:"idle",done:0,total:0,messageIndex:null},Tt=!1,Ct=null,Dt=null,Et=null,Nt="",_t=[],$t=null,At=[],Lt=null,Pt=!1,Rt=!1,jt=null;function Ot(t){return`${Gt(t)}:trace`}function qt(t){try{const e=Ot(t);if($t===e)return[...At];const n=localStorage.getItem(e);if(!n)return $t=e,At=[],[];const a=JSON.parse(n),s=Array.isArray(a?.lines)?a.lines.filter(t=>"string"==typeof t):[];return $t=e,At=s,[...s]}catch{return[]}}function zt(t,e){if(!yt?.debug)return;const n=`${(new Date).toISOString()} ${t}${e?` ${JSON.stringify(e)}`:""}`;_t.push(n),_t.length>200&&_t.splice(0,_t.length-200);const a=Vt();if(a){const t=qt(a);t.push(n),function(t,e){try{const n=Ot(t);$t=n,At=[...e],localStorage.setItem(n,JSON.stringify({savedAt:Date.now(),lines:e}))}catch{}}(a,t.slice(-1e3))}I(yt,t,e??{})}function Gt(t){const e=t;return`bst-debug:${String(e.chatId??e.chat_id??"").trim()||"nochat"}|${t.groupId?`group:${t.groupId}`:`char:${String(t.characterId??"unknown")}`}`}function Bt(t){try{localStorage.removeItem(Gt(t)),localStorage.removeItem(Ot(t)),$t=null,At=[]}catch{}}function Ht(t){for(let n=t.chat.length-1;n>=0;n-=1)if(e(t.chat[n]))return n;return null}function Jt(t,n){return!(n<0)&&(n>=t.chat.length||e(t.chat[n]))}function Ft(){yt&&(Tt||(Tt=!0,requestAnimationFrame(()=>{if(Tt=!1,!yt)return;const t=Vt(),n=[];if(t)for(let a=0;a<t.chat.length;a+=1){const s=t.chat[a];if(!e(s))continue;const o=P(s);o&&n.push({messageIndex:a,data:o})}wt&&null!=It&&!n.some(t=>t.messageIndex===It)&&n.push({messageIndex:It,data:wt}),"extracting"===Mt.phase&&null!=Mt.messageIndex&&t&&Jt(t,Mt.messageIndex)&&!n.some(t=>t.messageIndex===Mt.messageIndex)&&n.push({messageIndex:Mt.messageIndex,data:null}),"generating"===Mt.phase&&null!=Mt.messageIndex&&t&&Jt(t,Mt.messageIndex)&&!n.some(t=>t.messageIndex===Mt.messageIndex)&&n.push({messageIndex:Mt.messageIndex,data:null}),zt("render.queue",{entries:n.length,uiPhase:Mt.phase,uiMessageIndex:Mt.messageIndex,latestDataMessageIndex:It});const a=t?Ht(t):null;!function(t,e,n,a,s,o,r,i){ct();const c=function(t){const e=Array.from(new Set(t.filter(Boolean)));if(!e.length)return{};const n=[...e].sort((t,e)=>t.localeCompare(e)),a=Math.max(22,Math.floor(360/Math.max(1,n.length))),s=[],o={};for(const t of n){const e=rt(t);let n=e.h,r=-1;for(let t=0;t<16;t+=1){const o=(e.h+t*a)%360,i=s.length?Math.min(...s.map(t=>it(t,o))):360;i>r&&(r=i,n=o)}s.push(n),o[t]=`hsl(${n} ${e.s}% ${e.l}%)`}return o}(n),l=[...t].sort((t,e)=>t.messageIndex-e.messageIndex),d=t=>{for(let e=l.length-1;e>=0;e-=1){const n=l[e];if(!(n.messageIndex>=t)&&n.data)return n.data}return null},u=new Set(t.map(t=>String(t.messageIndex)));if(document.querySelectorAll(`.${K}`).forEach(t=>{const e=t,n=String(e.dataset.messageIndex??"");u.has(n)||e.remove()}),e.enabled)for(const l of t){const t=lt(l.messageIndex);if(!t)continue;if(t.style.setProperty("--bst-card","#1f2028"),t.style.setProperty("--bst-accent",e.accentColor),t.style.setProperty("--bst-radius",`${e.borderRadius}px`),t.style.opacity=`${e.cardOpacity}`,t.style.fontSize=`${e.fontSize}px`,t.style.display="grid",t.innerHTML="",t.dataset.bstBound||(t.dataset.bstBound="1",t.addEventListener("click",e=>{const n=e.target,a=n?.closest('[data-bst-action="graph"]');if(a){const t=String(a.getAttribute("data-character")??"").trim();if(!t)return;return void r?.(t)}const s=n?.closest('[data-bst-action="retrack"]');if(s){const e=Number(t.dataset.messageIndex);return void(Number.isNaN(e)||i?.(e))}const o=n?.closest('[data-bst-action="toggle-all-collapse"]');if(o){const e=Number(t.dataset.messageIndex);if(Number.isNaN(e))return;const n=!t.classList.contains("bst-root-collapsed");return t.classList.toggle("bst-root-collapsed",n),n?Z.add(e):Z.delete(e),o.setAttribute("aria-expanded",String(!n)),o.setAttribute("title",n?"Expand all trackers":"Collapse all trackers"),void(o.innerHTML=n?"&#9656; Expand all":"&#9662; Collapse all")}})),t.classList.toggle("bst-root-collapsed",Z.has(l.messageIndex)),"generating"===s.phase&&s.messageIndex===l.messageIndex){const e=document.createElement("div");e.className="bst-loading",e.innerHTML='\n        <div class="bst-loading-row">\n          <span>AI message is generating</span>\n          <span>running</span>\n        </div>\n        <div class="bst-loading-track bst-loading-track-indeterminate"><div class="bst-loading-fill"></div></div>\n        <div class="bst-loading-sub">Tracker will run after generation finishes.</div>\n      ',t.appendChild(e);continue}if("extracting"===s.phase&&s.messageIndex===l.messageIndex){const e=Math.max(1,s.total),n=Math.max(0,Math.min(e,s.done)),a=Math.max(0,Math.min(1,n/e)),o=Math.round(100*a),r=`stage ${Math.min(n+1,e)}/${e}`;let i="Preparing tracker context",c="Collecting recent messages and active characters.";1===n?(i="Requesting relationship analysis",c="Sending extraction prompt to backend/profile."):n>=2&&(i="Parsing and applying tracker update",c="Validating AI delta output and updating relationship state.");const l=document.createElement("div");l.className="bst-loading",l.innerHTML=`\n        <div class="bst-loading-row">\n          <span>${i}</span>\n          <span>${r} (${o}%)</span>\n        </div>\n        <div class="bst-loading-track"><div class="bst-loading-fill" style="width:${Math.round(100*a)}%"></div></div>\n        <div class="bst-loading-sub">${c}</div>\n      `,t.appendChild(l);continue}const u=l.data;if(!u){t.style.display="none";continue}const g=null!=o&&l.messageIndex===o;{const e=t.classList.contains("bst-root-collapsed"),n=document.createElement("div");n.className="bst-root-actions",n.innerHTML=`\n        <button class="bst-mini-btn" data-bst-action="toggle-all-collapse" title="${e?"Expand all trackers":"Collapse all trackers"}" aria-expanded="${String(!e)}">${e?"&#9656; Expand all":"&#9662; Collapse all"}</button>\n        ${g?'<button class="bst-mini-btn bst-mini-btn-icon bst-mini-btn-accent" data-bst-action="retrack" title="Retrack latest AI message" aria-label="Retrack latest AI message">&#x21BB;</button>':""}\n      `,t.appendChild(n)}const p=new Set(u.activeCharacters.map(et)),f=t=>void 0!==u.statistics.affection?.[t]||void 0!==u.statistics.trust?.[t]||void 0!==u.statistics.desire?.[t]||void 0!==u.statistics.connection?.[t]||void 0!==u.statistics.mood?.[t]||void 0!==u.statistics.lastThought?.[t],h=((a||e.showInactive)&&n.length>0?n:u.activeCharacters).filter(t=>f(t)||p.has(et(t)));for(const n of h){const a=p.has(et(n));if(!a&&!e.showInactive)continue;const s=d(l.messageIndex),r=String(u.statistics.mood?.[n]??"Neutral"),i=String(s?.statistics.mood?.[n]??r)===r?"stable":"shifted",g=document.createElement("div");g.className="bst-card"+(a?"":" bst-card-inactive"),g.style.setProperty("--bst-card-local",c[n]??ot(n));const f=tt(u.statistics.affection?.[n]??Q("affection",e)),h=tt(u.statistics.trust?.[n]??Q("trust",e)),m=tt(u.statistics.desire?.[n]??Q("desire",e)),b=tt(u.statistics.connection?.[n]??Q("connection",e));g.innerHTML=`\n        <div class="bst-head">\n          <div class="bst-name">${n}</div>\n          <div class="bst-actions">\n            <button class="bst-mini-btn" data-bst-action="graph" data-character="${n}" title="Open relationship graph"><span aria-hidden="true">&#128200;</span> Graph</button>\n            <div class="bst-state">${a?"Active":e.inactiveLabel}</div>\n          </div>\n        </div>\n        <div class="bst-collapsed-summary" title="Affection / Trust / Desire / Connection">\n          <span>A ${f}%</span>\n          <span>T ${h}%</span>\n          <span>D ${m}%</span>\n          <span>C ${b}%</span>\n          <span class="bst-collapsed-mood" title="${r}">${nt(r)}</span>\n        </div>\n        <div class="bst-body">\n        ${V.map(({key:t,label:a})=>{const r=tt(u.statistics[t]?.[n]??Q(t,e)),i=tt(s?.statistics[t]?.[n]??r),c=Math.round(r-i),d=c>0?"bst-delta bst-delta-up":c<0?"bst-delta bst-delta-down":"bst-delta bst-delta-flat";return`\n            <div class="bst-row">\n              <div class="bst-label"><span>${a}</span><span>${r}%${null!=o&&l.messageIndex===o?`<span class="${d}">${st(c)}</span>`:""}</span></div>\n              <div class="bst-track"><div class="bst-fill" style="width:${r}%"></div></div>\n            </div>\n          `}).join("")}\n        <div class="bst-mood" title="${r} (${i})">\n          <div class="bst-mood-wrap">\n            <span class="bst-mood-emoji">${nt(r)}</span>\n            <span class="bst-mood-badge" style="background:${at(r)};">${r} (${i})</span>\n          </div>\n        </div>\n        ${e.showLastThought?`<div class="bst-thought">${String(u.statistics.lastThought?.[n]??"")}</div>`:""}\n        </div>\n      `,t.appendChild(g)}}}(n,yt,St,Boolean(t?.groupId),Mt,a,t=>{const e=Vt();if(!e||!yt)return;const n=W(e,30);0===n.length&&wt&&n.push(wt);const a=function(t,e){const n=[...t].filter(t=>Number.isFinite(t.timestamp)).sort((t,e)=>t.timestamp-e.timestamp).filter(t=>void 0!==t.statistics.affection?.[e]||void 0!==t.statistics.trust?.[e]||void 0!==t.statistics.desire?.[e]||void 0!==t.statistics.connection?.[e]||void 0!==t.statistics.mood?.[e]||void 0!==t.statistics.lastThought?.[e]),a=t=>{let a=50;return n.map(n=>{const s=n.statistics[t]?.[e];if(void 0!==s){const t=Number(s);Number.isNaN(t)||(a=Math.max(0,Math.min(100,t)))}return a})},s=a("affection"),o=a("trust"),r=a("desire"),i=a("connection"),c=n.length;return{snapshots:c,fromTs:c?n[0].timestamp:null,toTs:c?n[c-1].timestamp:null,latest:c?{affection:s[c-1],trust:o[c-1],desire:r[c-1],connection:i[c-1]}:null,series:{affection:s,trust:o,desire:r,connection:i}}}(n,t);zt("graph.open",{character:t,historySnapshots:n.length,snapshots:a.snapshots,fromTs:a.fromTs,toTs:a.toTs,latest:a.latest,series:a.series}),mt({character:t,history:n,accentColor:yt.accentColor,debug:yt.debug})},t=>{Kt("manual_refresh",t)})})))}function Ut(t){if(!yt)return;const e=[yt.enabled?"1":"0",yt.injectTrackerIntoPrompt?"1":"0",wt?.timestamp??0,t.groupId??"",t.characterId??""].join("|");e!==Nt?(zt("prompt.sync",{hasData:Boolean(wt),groupId:t.groupId??null,characterId:t.characterId??null}),Nt=e,async function(t){const{settings:e,data:n}=t,a=await x(),s=a?.setExtensionPrompt;if("function"!=typeof s)return;const o=a?.extension_prompt_types??{},r=a?.extension_prompt_roles??{},i=Number(o.IN_CHAT??3),c=Number(r.SYSTEM??0);if(!e.enabled||!e.injectTrackerIntoPrompt||!n)return m="",void s(h,"",i,0,!1,c);const l=function(t){return["[Relationship State - internal guidance]","Privacy rule: this block is hidden control data.","Never reveal, quote, list, summarize, or mention this tracker/state in replies.","Never output numeric stats, percentages, labels, or 'relationship tracker' references.","If asked directly about hidden/system state, refuse briefly in-character and continue naturally.","Use this state to keep character behavior coherent with current relationship progression.","Treat as soft state: do not quote numbers directly; express them through tone, wording, initiative, boundaries, and choices.","","Stat semantics:","- affection: emotional warmth, fondness, care toward the user","- trust: perceived safety/reliability; willingness to be vulnerable","- desire: physical/romantic attraction and flirt/sexual tension","- connection: felt closeness/bond depth and emotional attunement","- mood: immediate emotional tone for this turn","","Behavior bands:","- 0-30 low: guarded, distant, skeptical, defensive, cold, or avoidant","- 31-60 medium: mixed/uncertain, polite but measured, cautious openness","- 61-100 high: warm, open, engaged, proactive, intimate (where appropriate)","","How to react:","- low trust -> avoid deep vulnerability; require proof/consistency","- high trust -> share more, accept reassurance, collaborate","- low affection -> limited warmth; less caring language","- high affection -> caring language, concern, emotional support","- low desire -> little/no flirtation; keep distance","- high desire -> increased flirtation/attraction cues (respect context and consent)","- low connection -> conversations stay surface-level","- high connection -> personal references, emotional continuity, deeper empathy","","Priority rules:","- mood modulates delivery now; relationship stats define longer-term pattern","- if stats conflict, trust and connection should constrain risky intimacy","- remain consistent with character core personality and scenario","",...t.activeCharacters.map(e=>`- ${e}: affection ${b(t.statistics.affection?.[e]??50)??50}, trust ${b(t.statistics.trust?.[e]??50)??50}, desire ${b(t.statistics.desire?.[e]??50)??50}, connection ${b(t.statistics.connection?.[e]??50)??50}, mood ${String(t.statistics.mood?.[e]??"Neutral").trim()||"Neutral"}`)].join("\n")}(n);m=l,s(h,l,i,0,!0,c)}({context:t,settings:yt,data:wt})):zt("prompt.sync.skip",{reason:"signature_unchanged"})}function Yt(t=80){null!==Et&&window.clearTimeout(Et),Et=window.setTimeout(()=>{Et=null,zt("refresh.run",{delay:t}),Zt()},t)}function Wt(t,e){null!==Ct&&window.clearTimeout(Ct),Ct=window.setTimeout(()=>{Ct=null,zt("extract.schedule.fire",{reason:t,targetMessageIndex:e??null}),Kt(t,e)},180)}function Xt(t,e){const n=Mt;Mt=e,zt("ui.phase",{from:n.phase,to:e.phase,messageIndex:e.messageIndex}),"idle"!==e.phase?t.deactivateSendButtons?.():t.activateSendButtons?.()}function Vt(){return function(){try{return SillyTavern.getContext()}catch{return null}}()}function Qt(t){if("number"==typeof t)return Number.isInteger(t)?t:null;if(!t||"object"!=typeof t)return null;const e=t,n=e.message??e.messageId??e.id;return"number"!=typeof n?null:Number.isInteger(n)?n:null}async function Kt(t,a){const s=Vt();if(!s)return;if(!yt?.enabled)return;if(0===s.chat.length)return;if(vt)return void zt("extract.skip",{reason:"already_extracting",trigger:t});let r=null;if("number"==typeof a&&a>=0&&a<s.chat.length&&e(s.chat[a])&&(r=a),null==r&&(r=function(t){return Ht(t)}(s)),null==r)return void zt("extract.skip",{reason:"no_ai_message",trigger:t});const c=s.chat[r];if("manual_refresh"!==t&&"MESSAGE_EDITED"!==t&&"MESSAGE_SWIPED"!==t&&"SWIPE_CHANGED"!==t&&"MESSAGE_SWIPE_CHANGED"!==t&&"MESSAGE_SWIPE_DELETED"!==t&&P(c))return void zt("extract.skip",{reason:"tracker_already_present",trigger:t,messageIndex:r});vt=!0;const h=++kt;zt("extract.start",{runId:h,reason:t,targetMessageIndex:a??null,resolvedMessageIndex:r}),Xt(s,{phase:"extracting",done:0,total:1,messageIndex:r}),Ft();try{const c=function(t,a){const s=n(t),o=Math.max(1,a.activityLookback),r={};if(!a.autoDetectActive){for(const t of s)r[t]="autoDetectActive disabled";return{allCharacterNames:s,activeCharacters:s,reasons:r,lookback:o}}const i=t.chat.slice(-o),c=new Set;for(const t of i)t.name&&e(t)&&s.includes(t.name)&&(c.add(t.name),r[t.name]=`spoke in last ${o} messages`);const l=Math.max(6,3*o),d=Math.max(0,t.chat.length-l),u=t.chat.slice(d),g=(t,e)=>{const n=t.toLowerCase().replace(/\s+/g," ").trim(),a=e.toLowerCase().trim();if(!n||!a||!n.includes(a))return!1;const s=["went","goes","left","leaves","walked","walks","ran","returns","returned","headed","moved","retreated","stayed in","stays in","is in"].some(t=>n.includes(t)),o=["away","out","back","home","room","bedroom","upstairs","downstairs","outside","bathroom","hallway","kitchen","garden","her room","his room","their room"].some(t=>n.includes(t));return s&&o};for(const n of s){let a=-1;for(let t=0;t<u.length;t+=1){const e=u[t];if(!e.is_user||e.is_system)continue;const s=String(e.mes??"");s.trim()&&g(s,n)&&(a=d+t)}if(a<0)continue;let s=!1;for(let o=a+1;o<t.chat.length;o+=1){const a=t.chat[o];if(e(a)&&String(a.name??"").trim()===n){s=!0;break}}s?r[n]=`departure cue at message ${a}, but spoke later`:(c.delete(n),r[n]=`departure cue at message ${a}, no speech after`)}if(0===c.size){const n=s.filter(n=>{let a=-1;for(let t=0;t<u.length;t+=1){const e=u[t];if(!e.is_user||e.is_system)continue;const s=String(e.mes??"");s.trim()&&g(s,n)&&(a=d+t)}if(a<0)return!0;for(let s=a+1;s<t.chat.length;s+=1){const o=t.chat[s];if(e(o)&&String(o.name??"").trim()===n)return r[n]=`fallback visibility: spoke after departure cue at ${a}`,!0}return r[n]=`fallback visibility: hidden after departure cue at ${a}`,!1}),a=n.length?n:s;for(const t of a)r[t]||(r[t]="fallback: include all tracked characters");return{allCharacterNames:s,activeCharacters:a,reasons:r,lookback:o}}const p=Array.from(c);for(const t of s)r[t]||(r[t]=p.includes(t)?`no departure cue; included by recent activity window (${o})`:`not seen in recent activity window (${o})`);return{allCharacterNames:s,activeCharacters:p,reasons:r,lookback:o}}(s,yt);Lt=c,St=c.allCharacterNames;const m=c.activeCharacters;if(zt("activity.resolve",{allCharacterNames:St,activeCharacters:m,lookback:c.lookback,autoDetectActive:yt.autoDetectActive,reasons:c.reasons}),!m.length)return void zt("extract.skip",{reason:"no_active_characters",runId:h});const b="number"==typeof a&&a>=0?function(t,e){for(let n=Math.min(Math.max(e-1,0),t.chat.length-1);n>=0;n-=1){const e=P(t.chat[n]);if(e)return{data:e,messageIndex:n}}return null}(s,a):O(s);let x=b?.data??null;x||(wt=function(t,e){const n=Vt(),a=new Map((n?.characters??[]).map(t=>[t.name,t])),s=(t,e)=>{const n=Number(t);return Number.isNaN(n)?e:Math.max(0,Math.min(100,n))},o=t=>{const o=(t=>{const a=(n?.chat??[]).slice(-Math.max(8,e.contextMessages)).filter(e=>!e.is_system&&(String(e.name??"")===t||e.is_user)).map(t=>String(t.mes??"").toLowerCase()).join("\n"),s=t=>(a.match(t)??[]).length,o=s(/\b(love|care|trust|safe|support|hug|kiss|thank|gentle|close|warm|happy)\b/g),r=s(/\b(hate|angry|mad|fight|betray|jealous|cold|distant|ignore|fear|resent)\b/g),i=s(/\b(kiss|touch|desire|want you|flirt|blush|attract|yearn|tease)\b/g),c=Math.max(-30,Math.min(30,4*(o-r))),l=Math.max(-25,Math.min(25,6*i-3*Math.max(0,r-o))),d=r>o?"Frustrated":i>0?"Hopeful":o>0?"Content":"Neutral";return{affection:Math.max(0,Math.min(100,Math.round(45+c))),trust:Math.max(0,Math.min(100,Math.round(45+Math.max(-25,Math.min(25,3*(o-r)))))),desire:Math.max(0,Math.min(100,Math.round(35+l))),connection:Math.max(0,Math.min(100,Math.round(48+Math.max(-28,Math.min(28,3*(o-r)+Math.floor(o/2)))))),mood:d}})(t),r=a.get(t),i=r?.extensions,c=r?.data?.extensions,l=i?.bettersimtracker??c?.bettersimtracker,d=l?.defaults??{};return void 0!==d.affection||void 0!==d.trust||void 0!==d.desire||void 0!==d.connection||void 0!==d.mood?{affection:s(d.affection,o.affection),trust:s(d.trust,o.trust),desire:s(d.desire,o.desire),connection:s(d.connection,o.connection),mood:(u=d.mood,g=o.mood,"string"==typeof u&&u.trim()?u.trim():g)}:o;var u,g};return{timestamp:Date.now(),activeCharacters:t,statistics:{affection:Object.fromEntries(t.map(t=>[t,o(t).affection])),trust:Object.fromEntries(t.map(t=>[t,o(t).trust])),desire:Object.fromEntries(t.map(t=>[t,o(t).desire])),connection:Object.fromEntries(t.map(t=>[t,o(t).connection])),mood:Object.fromEntries(t.map(t=>[t,o(t).mood])),lastThought:Object.fromEntries(t.map(t=>[t,""]))}}}(m,yt),It=r,Ft(),x=wt,zt("extract.baseline",{runId:h,forMessageIndex:r,activeCharacters:m.length}));const y=s.name1??"User",v=function(t,n){return t.chat.slice(-Math.max(1,n)).map(n=>n.is_user||e(n)?`${n.is_user?t.name1??"User":n.name??"Character"}: ${n.mes}`:null).filter(t=>Boolean(t)).join("\n\n")}(s,yt.contextMessages);I(yt,`Extraction started (${t})`,{activeCharacters:m,allCharacterNames:St,runId:h});const k=await async function(t){const{settings:e,userName:n,activeCharacters:a,contextText:s,previousStatistics:r,history:c,onProgress:h}=t,m=function(t){const e=[];return t.trackAffection&&e.push("affection"),t.trackTrust&&e.push("trust"),t.trackDesire&&e.push("desire"),t.trackConnection&&e.push("connection"),t.trackMood&&e.push("mood"),t.trackLastThought&&e.push("lastThought"),e}(e),b={affection:{},trust:{},desire:{},connection:{},mood:{},lastThought:{}};let x=null;if(!m.length||!a.length)return{statistics:b,debug:x};h?.(0,e.sequentialExtraction?Math.max(1,3*m.length):3);try{const t=(t,n,a)=>{const s=Math.max(0,Math.min(1,a)),o=Math.max(0,Math.min(1,e.confidenceDampening)),r=1-o+s*o,i=Math.max(1,Math.round(e.maxDeltaPerTurn||15)),c=Math.max(-i,Math.min(i,n));return l=t+Math.round(c*r),Math.max(0,Math.min(100,Math.round(l)));var l},o={affection:{},trust:{},desire:{},connection:{},mood:{},lastThought:{}},y=new Set,v={confidence:{},deltas:{affection:{},trust:{},desire:{},connection:{}},mood:{},lastThought:{}},k=(n,s)=>{for(const[t,e]of Object.entries(s.confidence))v.confidence[t]=e;for(const i of a){const a=s.confidence[i]??.8;if("affection"===n&&void 0!==s.deltas.affection[i]){v.deltas.affection[i]=s.deltas.affection[i];const n=Number(r?.affection?.[i]??e.defaultAffection),c=t(n,s.deltas.affection[i],a);b.affection[i]=c,o.affection[i]=c}if("trust"===n&&void 0!==s.deltas.trust[i]){v.deltas.trust[i]=s.deltas.trust[i];const n=Number(r?.trust?.[i]??e.defaultTrust),c=t(n,s.deltas.trust[i],a);b.trust[i]=c,o.trust[i]=c}if("desire"===n&&void 0!==s.deltas.desire[i]){v.deltas.desire[i]=s.deltas.desire[i];const n=Number(r?.desire?.[i]??e.defaultDesire),c=t(n,s.deltas.desire[i],a);b.desire[i]=c,o.desire[i]=c}if("connection"===n&&void 0!==s.deltas.connection[i]){v.deltas.connection[i]=s.deltas.connection[i];const n=Number(r?.connection?.[i]??e.defaultConnection),c=t(n,s.deltas.connection[i],a);b.connection[i]=c,o.connection[i]=c}if("mood"===n&&void 0!==s.mood[i]){v.mood[i]=s.mood[i];const t=Math.max(0,Math.min(1,e.moodStickiness)),n=String(r?.mood?.[i]??e.defaultMood),c=a<t;b.mood[i]=c?n:s.mood[i],o.mood[i]=b.mood[i]}"lastThought"===n&&void 0!==s.lastThought[i]&&(v.lastThought[i]=s.lastThought[i],b.lastThought[i]=s.lastThought[i],o.lastThought[i]=s.lastThought[i])}if("mood"===n)for(const t of a){if(void 0!==b.mood[t])continue;const n=String(r?.mood?.[t]??e.defaultMood);b.mood[t]=n,o.mood[t]=n,y.add(t)}};let S=0,w=!1,I=!0,M="",T="",C=0;const D=e.sequentialExtraction?Math.max(1,3*m.length):3,E=()=>{C=Math.min(D,C+1),h?.(C,D)},N=async t=>{const o=function(t,e,n,a,s,o=[],r=15){const i=function(t,e,n){return[`User: ${t}`,`Characters: ${e.join(", ")}`,"","Recent messages:",n,""].join("\n")}(e,n,a),c=t.filter(t=>"affection"===t||"trust"===t||"desire"===t||"connection"===t),l=t.filter(t=>"mood"===t||"lastThought"===t),u=n.map(t=>{const e=Number(s?.affection?.[t]??50),n=Number(s?.trust?.[t]??50),a=Number(s?.desire?.[t]??50),o=Number(s?.connection?.[t]??50),r=String(s?.mood?.[t]??"Neutral");return`- ${t}: affection=${Math.max(0,Math.min(100,Math.round(e)))}, trust=${Math.max(0,Math.min(100,Math.round(n)))}, desire=${Math.max(0,Math.min(100,Math.round(a)))}, connection=${Math.max(0,Math.min(100,Math.round(o)))}, mood=${r}`}).join("\n"),g=o.slice(0,3).map((t,e)=>`Snapshot ${e+1} (newest-${e}):\n${n.map(e=>{const n=Number(t.statistics.affection?.[e]??50),a=Number(t.statistics.trust?.[e]??50),s=Number(t.statistics.desire?.[e]??50),o=Number(t.statistics.connection?.[e]??50),r=String(t.statistics.mood?.[e]??"Neutral");return`  - ${e}: affection=${Math.round(n)}, trust=${Math.round(a)}, desire=${Math.round(s)}, connection=${Math.round(o)}, mood=${r}`}).join("\n")}`).join("\n"),p=Math.max(1,Math.round(Number(r)||15));return`${i}\nCurrent tracker state:\n${u}\n\nRecent tracker snapshots:\n${g||"- none"}\n\nTask:\n- Propose incremental changes to tracker state from the recent messages.\n- Do NOT rewrite absolute values; provide per-stat deltas.\n- Keep updates conservative and realistic.\n\nNumeric stats to update (${c.length?c.join(", "):"none"}):\n- Return deltas only, each in range -${p}..${p}.\n\nText stats to update (${l.length?l.join(", "):"none"}):\n- mood must be one of: ${d.join(", ")}.\n- lastThought must be one short sentence.\n\nReturn STRICT JSON only:\n{\n  "characters": [\n    {\n      "name": "Character Name",\n      "confidence": 0.0,\n      "delta": {\n        "affection": 0,\n        "trust": 0,\n        "desire": 0,\n        "connection": 0\n      },\n      "mood": "Neutral",\n      "lastThought": ""\n    }\n  ]\n}\n\nRules:\n- confidence is 0..1 (0 low confidence, 1 high confidence).\n- include one entry for each character name exactly: ${n.join(", ")}.\n- omit fields for stats that are not requested.\n- output JSON only, no commentary.`}(t,n,a,s,r,c,e.maxDeltaPerTurn);E(),S+=1;let f=await i(o,e);E();let h=l(f,a,t,e.maxDeltaPerTurn);const m=function(t){return u(t.confidence)||u(t.deltas.affection)||u(t.deltas.trust)||u(t.deltas.desire)||u(t.deltas.connection)||u(t.mood)||u(t.lastThought)}(h);I=I&&m;let b=Math.max(0,Math.min(4,e.maxRetriesPerStat));if(!g(h,t)&&b>0&&e.strictJsonRepair){const n=p(o);S+=1,w=!0,b-=1;const s=await i(n,e),r=l(s,a,t,e.maxDeltaPerTurn);g(r,t)&&(f=s,h=r)}if(1===t.length&&!g(h,t)&&b>0&&e.strictJsonRepair){const n=(x=o,"mood"===(y=t[0])?["SYSTEM OVERRIDE:","Return ONLY valid JSON, no prose, no roleplay.","MANDATORY: include `mood` for every character.","Use one of allowed mood labels exactly.","",x].join("\n"):"lastThought"===y?["SYSTEM OVERRIDE:","Return ONLY valid JSON, no prose, no roleplay.","MANDATORY: include `lastThought` for every character.","Keep it to one short sentence per character.","",x].join("\n"):p(x));S+=1,w=!0,b-=1;const s=await i(n,e),r=l(s,a,t,e.maxDeltaPerTurn);g(r,t)&&(f=s,h=r)}for(var x,y;!g(h,t)&&b>0&&e.strictJsonRepair;){const n=p(o);S+=1,w=!0,b-=1;const s=await i(n,e),r=l(s,a,t,e.maxDeltaPerTurn);if(g(r,t)){f=s,h=r;break}}return E(),{prompt:o,raw:f,parsedOne:h}};if(e.sequentialExtraction){const t=[...m],n=Math.max(1,Math.min(e.maxConcurrentCalls||1,8)),a=[],s=[],o=async()=>{for(;t.length;){const e=t.shift();if(!e)return;const n=await N([e]);a.push({stat:e,raw:n.raw}),s.push({stat:e,prompt:n.prompt}),k(e,n.parsedOne)}};await Promise.all(Array.from({length:Math.min(n,m.length)},()=>o())),M=a.map(t=>`--- ${t.stat} ---\n${t.raw}`).join("\n\n"),T=s.map(t=>`--- ${t.stat} ---\n${t.prompt}`).join("\n\n")}else{const t=await N(m);M=t.raw,T=t.prompt;for(const e of m)k(e,t.parsedOne)}x={rawModelOutput:M,promptText:e.includeContextInDiagnostics?T:void 0,contextText:e.includeContextInDiagnostics?s:void 0,parsed:v,applied:o,meta:{promptChars:T.length,contextChars:s.length,historySnapshots:c.length,activeCharacters:[...a],statsRequested:[...m],attempts:S,extractionMode:e.sequentialExtraction?"sequential":"unified",retryUsed:w,firstParseHadValues:I,rawLength:M.length,parsedCounts:{confidence:f(v.confidence),affection:f(v.deltas.affection),trust:f(v.deltas.trust),desire:f(v.deltas.desire),connection:f(v.deltas.connection),mood:f(v.mood),lastThought:f(v.lastThought)},appliedCounts:{affection:f(o.affection),trust:f(o.trust),desire:f(o.desire),connection:f(o.connection),mood:f(o.mood),lastThought:f(o.lastThought)},moodFallbackApplied:Array.from(y)}}}catch(t){console.error("[BetterSimTracker] Unified extraction failed:",t)}finally{const t=e.sequentialExtraction?Math.max(1,3*m.length):3;h?.(t,t)}e.trackMood||(b.mood=Object.fromEntries(a.map(t=>[t,e.defaultMood])));for(const t of o)b[t]||(b[t]={});return{statistics:b,debug:x}}({settings:yt,userName:y,activeCharacters:m,contextText:v,previousStatistics:x?.statistics??null,history:W(s,6),onProgress:(t,e)=>{zt("extract.progress",{runId:h,done:t,total:e}),Xt(s,{phase:"extracting",done:t,total:e,messageIndex:r}),Ft()}}),S=k.statistics;if(Dt=k.debug,Dt){const t=qt(s).slice(-200);Dt.trace=t.length?t:[..._t]}if(function(t,e){try{if(!e)return;localStorage.setItem(Gt(t),JSON.stringify({savedAt:Date.now(),record:e}))}catch{}}(s,Dt),h!==kt)return void zt("extract.skip",{reason:"stale_run",runId:h,currentRunId:kt});const w=function(t,e){const n={affection:{},trust:{},desire:{},connection:{},mood:{},lastThought:{}};for(const a of o){const s=t[a]??{},o=e?.[a]??{};n[a]={...o,...s}}return n}(S,x?.statistics??null);wt={timestamp:Date.now(),activeCharacters:m,statistics:w},It=r,X(s,wt,r),s.saveChatDebounced?.(),await(s.saveChat?.()),Ut(s),Ft(),zt("extract.finish",{runId:h,reason:t,savedMessageIndex:r,activeCharacters:m.length}),I(yt,`Extraction finished (${t})`)}catch(e){zt("extract.error",{reason:t,message:e instanceof Error?e.message:String(e)}),console.error("[BetterSimTracker] Extraction failed:",e)}finally{vt=!1,Xt(s,{phase:"idle",done:0,total:0,messageIndex:It}),Ft()}}function Zt(){const t=Vt();if(!t||!yt)return;St=n(t);const a=O(t),s=function(t){const e=Y(t);return e.latest?.data?{data:e.latest.data,messageIndex:Number(e.latest.messageIndex??-1)}:null}(t),o=function(t){const e=U(t);return e.latest?.data?{data:e.latest.data,messageIndex:Number(e.latest.messageIndex??-1)}:null}(t),r=function(t){const e=F(t);if(e.latest?.data)return{data:e.latest.data,messageIndex:Number(e.latest.messageIndex??-1)};const n=q(t),a=H()[n];return a?.data?{data:a.data,messageIndex:Number(a.messageIndex??-1)}:null}(t),i=Ht(t),c=n=>!!n&&(null!=i&&(n.messageIndex===i&&(!(n.messageIndex<0||n.messageIndex>=t.chat.length)&&e(t.chat[n.messageIndex]))));Dt||(Dt=function(t){try{const e=localStorage.getItem(Gt(t));if(e){const t=JSON.parse(e);return t.record?t.record:t}const n=function(t){return"|"+(t.groupId?`group:${t.groupId}`:`char:${String(t.characterId??"unknown")}`)}(t);let a=null;for(let t=0;t<localStorage.length;t+=1){const e=localStorage.key(t);if(!e||!e.startsWith("bst-debug:"))continue;if(!e.endsWith(n))continue;const s=localStorage.getItem(e);if(!s)continue;const o=JSON.parse(s),r=o.record??o,i=Number(o.savedAt??0);(!a||i>a.savedAt)&&(a={record:r,savedAt:i})}return a?.record??null}catch{return null}}(t),Dt&&yt.debug&&(Dt.trace=qt(t).slice(-200)));let l="none";var d;(d=a)&&!(d.messageIndex<0||d.messageIndex>=t.chat.length)&&e(t.chat[d.messageIndex])?(wt=a.data,It=a.messageIndex,l="message"):c(s)?(wt=s.data,It=s.messageIndex,l="chatState"):c(o)?(wt=o.data,It=o.messageIndex,l="metadata"):c(r)?(wt=r.data,It=r.messageIndex,l="local"):(wt=null,It=null),null!=i&&wt&&"message"===l?It=i:wt?wt&&null==i&&Yt(300):It=null,"idle"===Mt.phase&&(Mt={...Mt,messageIndex:It}),zt("refresh.resolve",{source:l,lastAiIndex:i,latestDataMessageIndex:It,hasLatestData:Boolean(wt)}),Ut(t),Ft(),function(t){const e=function(){for(const t of k){const e=document.querySelector(t);if(e instanceof HTMLElement)return e}return null}();if(!e)return;let n=document.getElementById(v);n||(n=document.createElement("div"),n.id=v,n.className="extension_block",e.appendChild(n)),n.innerHTML=`\n    <div class="inline-drawer">\n      <div class="inline-drawer-toggle inline-drawer-header">\n        <b>BetterSimTracker</b>\n        <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>\n      </div>\n      <div class="inline-drawer-content">\n        <label class="checkbox_label" style="display:flex;align-items:center;gap:8px;margin:8px 0;">\n          <input id="bst-settings-enabled" type="checkbox" ${t.settings.enabled?"checked":""}>\n          <span>Enabled</span>\n        </label>\n        <button id="bst-open-settings" class="menu_button">Open BetterSimTracker Settings</button>\n      </div>\n    </div>\n  `;const a=n.querySelector("#bst-settings-enabled");a instanceof HTMLInputElement&&a.addEventListener("change",()=>{t.onSave({enabled:a.checked})}),n.querySelector("#bst-open-settings")?.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),t.onOpenModal()})}({settings:yt,onSave:e=>{yt&&t&&(yt={...yt,...e},w(t,yt),Zt())},onOpenModal:()=>te()})}function te(){if(!yt)return;const t=Vt();!function(t){ct(),xt();const e=document.createElement("div");e.className="bst-settings-backdrop",e.addEventListener("click",()=>xt()),document.body.appendChild(e);const n=new Map;for(const e of t.profileOptions)n.set(e.id,e.label);t.settings.connectionProfile&&!n.has(t.settings.connectionProfile)&&n.set(t.settings.connectionProfile,`${t.settings.connectionProfile} (current)`);const a=['<option value="">Use active connection</option>',...Array.from(n.entries()).map(([t,e])=>`<option value="${t}">${e}</option>`)].join(""),s=document.createElement("div");s.className="bst-settings",s.innerHTML=`\n    <div class="bst-settings-top">\n      <div>\n        <h3>BetterSimTracker Settings</h3>\n        <p class="bst-settings-subtitle">Changes are saved automatically.</p>\n      </div>\n      <button class="bst-btn bst-close-btn" data-action="close" title="Close settings" aria-label="Close settings">&times;</button>\n    </div>\n    <div class="bst-settings-section">\n      <h4>Quick Help</h4>\n      <div class="bst-help-line"><strong>Extraction mode:</strong> Unified = faster single request. Sequential = one request per stat (more robust, slower).</div>\n      <ul class="bst-help-list">\n        <li><strong>Affection:</strong> emotional warmth and care</li>\n        <li><strong>Trust:</strong> safety and willingness to be vulnerable</li>\n        <li><strong>Desire:</strong> attraction/flirt tension</li>\n        <li><strong>Connection:</strong> bond depth and emotional attunement</li>\n      </ul>\n      <div class="bst-help-line"><strong>Mood</strong> is short-term tone. <strong>Last Thought</strong> is one brief internal line for continuity.</div>\n    </div>\n    <div class="bst-settings-section">\n      <h4>Extraction</h4>\n      <div class="bst-settings-grid">\n        <label>Connection Profile <select data-k="connectionProfile">${a}</select></label>\n        <label class="bst-check"><input data-k="sequentialExtraction" type="checkbox">Sequential Extraction (per stat)</label>\n        <label data-bst-row="maxConcurrentCalls">Max Concurrent Requests <input data-k="maxConcurrentCalls" type="number" min="1" max="8"></label>\n        <label class="bst-check"><input data-k="strictJsonRepair" type="checkbox">Strict JSON Repair</label>\n        <label data-bst-row="maxRetriesPerStat">Max Retries Per Stat <input data-k="maxRetriesPerStat" type="number" min="0" max="4"></label>\n        <label>Context Messages <input data-k="contextMessages" type="number" min="1" max="40"></label>\n        <label>Max Delta Per Turn <input data-k="maxDeltaPerTurn" type="number" min="1" max="30"></label>\n        <label>Confidence Dampening <input data-k="confidenceDampening" type="number" min="0" max="1" step="0.05"></label>\n        <label>Mood Stickiness <input data-k="moodStickiness" type="number" min="0" max="1" step="0.05"></label>\n        <label class="bst-check"><input data-k="injectTrackerIntoPrompt" type="checkbox">Inject Tracker Into Prompt</label>\n        <label class="bst-check"><input data-k="autoDetectActive" type="checkbox">Auto Detect Active</label>\n        <label data-bst-row="activityLookback">Activity Lookback <input data-k="activityLookback" type="number" min="1" max="25"></label>\n      </div>\n    </div>\n    <div class="bst-settings-section">\n      <h4>Tracked Stats</h4>\n      <div class="bst-settings-grid">\n        <label class="bst-check"><input data-k="trackAffection" type="checkbox">Track Affection</label>\n        <label class="bst-check"><input data-k="trackTrust" type="checkbox">Track Trust</label>\n        <label class="bst-check"><input data-k="trackDesire" type="checkbox">Track Desire</label>\n        <label class="bst-check"><input data-k="trackConnection" type="checkbox">Track Connection</label>\n        <label class="bst-check"><input data-k="trackMood" type="checkbox">Track Mood</label>\n        <label class="bst-check"><input data-k="trackLastThought" type="checkbox">Track Last Thought</label>\n      </div>\n    </div>\n    <div class="bst-settings-section">\n      <h4>Display</h4>\n      <div class="bst-settings-grid">\n        <label class="bst-check"><input data-k="showInactive" type="checkbox">Show Inactive</label>\n        <label data-bst-row="inactiveLabel">Inactive Label <input data-k="inactiveLabel" type="text"></label>\n        <label class="bst-check"><input data-k="showLastThought" type="checkbox">Show Last Thought</label>\n        <label>Accent Color <input data-k="accentColor" type="text"></label>\n        <label>Card Opacity <input data-k="cardOpacity" type="number" min="0.1" max="1" step="0.01"></label>\n        <label>Border Radius <input data-k="borderRadius" type="number" min="0" max="32"></label>\n        <label>Font Size <input data-k="fontSize" type="number" min="10" max="22"></label>\n      </div>\n    </div>\n    <div class="bst-settings-section">\n      <h4>Debug</h4>\n      <div class="bst-settings-grid">\n        <label class="bst-check"><input data-k="debug" type="checkbox">Debug</label>\n      </div>\n      <div data-bst-row="debugBody">\n        <div class="bst-settings-grid">\n        <label class="bst-check" data-bst-row="includeContextInDiagnostics"><input data-k="includeContextInDiagnostics" type="checkbox">Include Context In Diagnostics</label>\n        <label class="bst-check" data-bst-row="includeGraphInDiagnostics"><input data-k="includeGraphInDiagnostics" type="checkbox">Include Graph Data In Diagnostics</label>\n        </div>\n        <div class="bst-debug-actions">\n          <button class="bst-btn bst-btn-soft bst-btn-icon" data-action="retrack" title="Retrack Last AI Message" aria-label="Retrack Last AI Message"><span aria-hidden="true">&#x21BB;</span></button>\n          <button class="bst-btn bst-btn-danger" data-action="clear-chat" title="Delete all tracker data for the currently open chat only.">Delete Tracker Data (Current Chat)</button>\n          <button class="bst-btn" data-action="dump-diagnostics" title="Collect and copy current diagnostics report to clipboard.">Dump Diagnostics</button>\n          <button class="bst-btn bst-btn-danger" data-action="clear-diagnostics" title="Clear stored diagnostics traces and last debug record for this chat scope.">Clear Diagnostics</button>\n        </div>\n        <div style="margin-top:8px;font-size:12px;opacity:.9;">Latest Extraction Debug Record</div>\n        <div class="bst-debug-box">${t.debugRecord?JSON.stringify(t.debugRecord,null,2):"No debug record yet."}</div>\n        <div style="margin-top:8px;font-size:12px;opacity:.9;">Latest Injected Prompt Block</div>\n        <div class="bst-debug-box">${t.injectedPrompt?.trim()?t.injectedPrompt:"No injected prompt currently active."}</div>\n      </div>\n    </div>\n  `,document.body.appendChild(s);const o=(t,e)=>{const n=s.querySelector(`[data-k="${t}"]`);n&&(n instanceof HTMLInputElement&&"checkbox"===n.type?n.checked="true"===e:n.value=e)};o("connectionProfile",t.settings.connectionProfile),o("sequentialExtraction",String(t.settings.sequentialExtraction)),o("maxConcurrentCalls",String(t.settings.maxConcurrentCalls)),o("strictJsonRepair",String(t.settings.strictJsonRepair)),o("maxRetriesPerStat",String(t.settings.maxRetriesPerStat)),o("contextMessages",String(t.settings.contextMessages)),o("maxDeltaPerTurn",String(t.settings.maxDeltaPerTurn)),o("confidenceDampening",String(t.settings.confidenceDampening)),o("moodStickiness",String(t.settings.moodStickiness)),o("injectTrackerIntoPrompt",String(t.settings.injectTrackerIntoPrompt)),o("autoDetectActive",String(t.settings.autoDetectActive)),o("activityLookback",String(t.settings.activityLookback)),o("showInactive",String(t.settings.showInactive)),o("inactiveLabel",t.settings.inactiveLabel),o("showLastThought",String(t.settings.showLastThought)),o("trackAffection",String(t.settings.trackAffection)),o("trackTrust",String(t.settings.trackTrust)),o("trackDesire",String(t.settings.trackDesire)),o("trackConnection",String(t.settings.trackConnection)),o("trackMood",String(t.settings.trackMood)),o("trackLastThought",String(t.settings.trackLastThought)),o("accentColor",t.settings.accentColor),o("cardOpacity",String(t.settings.cardOpacity)),o("borderRadius",String(t.settings.borderRadius)),o("fontSize",String(t.settings.fontSize)),o("debug",String(t.settings.debug)),o("includeContextInDiagnostics",String(t.settings.includeContextInDiagnostics)),o("includeGraphInDiagnostics",String(t.settings.includeGraphInDiagnostics));const r=()=>{const e=t=>(s.querySelector(`[data-k="${t}"]`)?.value??"").trim(),n=t=>{const n=s.querySelector(`[data-k="${t}"]`);return n instanceof HTMLInputElement&&"checkbox"===n.type?n.checked:"true"===e(t)},a=(t,n,a,s)=>{const o=Number(e(t));if(Number.isNaN(o))return n;let r=o;return"number"==typeof a&&(r=Math.max(a,r)),"number"==typeof s&&(r=Math.min(s,r)),r};return{...t.settings,connectionProfile:e("connectionProfile"),sequentialExtraction:n("sequentialExtraction"),maxConcurrentCalls:a("maxConcurrentCalls",t.settings.maxConcurrentCalls,1,8),strictJsonRepair:n("strictJsonRepair"),maxRetriesPerStat:a("maxRetriesPerStat",t.settings.maxRetriesPerStat,0,4),contextMessages:a("contextMessages",t.settings.contextMessages,1,40),maxDeltaPerTurn:a("maxDeltaPerTurn",t.settings.maxDeltaPerTurn,1,30),confidenceDampening:a("confidenceDampening",t.settings.confidenceDampening,0,1),moodStickiness:a("moodStickiness",t.settings.moodStickiness,0,1),injectTrackerIntoPrompt:n("injectTrackerIntoPrompt"),autoDetectActive:n("autoDetectActive"),activityLookback:a("activityLookback",t.settings.activityLookback,1,25),showInactive:n("showInactive"),inactiveLabel:e("inactiveLabel")||t.settings.inactiveLabel,showLastThought:n("showLastThought"),trackAffection:n("trackAffection"),trackTrust:n("trackTrust"),trackDesire:n("trackDesire"),trackConnection:n("trackConnection"),trackMood:n("trackMood"),trackLastThought:n("trackLastThought"),accentColor:e("accentColor")||t.settings.accentColor,cardOpacity:a("cardOpacity",t.settings.cardOpacity,.1,1),borderRadius:a("borderRadius",t.settings.borderRadius,0,32),fontSize:a("fontSize",t.settings.fontSize,10,22),debug:n("debug"),includeContextInDiagnostics:n("includeContextInDiagnostics"),includeGraphInDiagnostics:n("includeGraphInDiagnostics")}},i=()=>{const t=s.querySelector('[data-bst-row="maxConcurrentCalls"]'),e=s.querySelector('[data-bst-row="maxRetriesPerStat"]'),n=s.querySelector('[data-bst-row="activityLookback"]'),a=s.querySelector('[data-bst-row="inactiveLabel"]'),o=s.querySelector('[data-bst-row="debugBody"]'),i=s.querySelector('[data-bst-row="includeContextInDiagnostics"]'),c=s.querySelector('[data-bst-row="includeGraphInDiagnostics"]'),l=r();t&&(t.style.display=l.sequentialExtraction?"flex":"none",t.style.flexDirection="column",t.style.gap="4px"),e&&(e.style.display=l.strictJsonRepair?"flex":"none",e.style.flexDirection="column",e.style.gap="4px"),n&&(n.style.display=l.autoDetectActive?"flex":"none",n.style.flexDirection="column",n.style.gap="4px"),a&&(a.style.display=l.showInactive?"flex":"none",a.style.flexDirection="column",a.style.gap="4px"),o&&(o.style.display=l.debug?"block":"none"),i&&(i.style.display=l.debug?"flex":"none"),c&&(c.style.display=l.debug?"flex":"none")},c=()=>{const e=r();t.settings=e,t.onSave(e),i()};s.querySelectorAll("input, select").forEach(t=>{t.addEventListener("change",c),t instanceof HTMLInputElement&&"number"===t.type&&t.addEventListener("input",c)}),i();const l={connectionProfile:"Choose a specific SillyTavern connection profile for tracker extraction calls.",sequentialExtraction:"Run one extraction prompt per stat instead of one unified prompt. More robust but slower.",maxConcurrentCalls:"When sequential mode is enabled, number of stat requests sent in parallel.",strictJsonRepair:"Enable strict retry prompts when model output is not valid or missing required fields.",maxRetriesPerStat:"Maximum repair retries for each stat extraction stage.",contextMessages:"How many recent chat messages are included in tracker extraction context.",maxDeltaPerTurn:"Hard cap for stat change magnitude in one tracker update before confidence scaling.",confidenceDampening:"How strongly model confidence scales stat deltas (0 = ignore confidence, 1 = full effect).",moodStickiness:"Higher values keep previous mood unless confidence is strong.",injectTrackerIntoPrompt:"Inject current relationship state into generation prompt for behavioral coherence.",autoDetectActive:"Automatically decide which group characters are active in current scene.",activityLookback:"How many recent messages are scanned for active-speaker detection.",trackAffection:"Enable Affection stat extraction and updates.",trackTrust:"Enable Trust stat extraction and updates.",trackDesire:"Enable Desire stat extraction and updates.",trackConnection:"Enable Connection stat extraction and updates.",trackMood:"Enable mood extraction and mood display updates.",trackLastThought:"Enable hidden short internal thought extraction.",showInactive:"Show tracker cards for inactive/off-screen characters.",inactiveLabel:"Text label shown on cards for inactive characters.",showLastThought:"Show extracted last thought text inside tracker cards.",accentColor:"Accent color for fills, highlights, and action emphasis.",cardOpacity:"Overall tracker container opacity.",borderRadius:"Corner roundness for tracker cards and controls.",fontSize:"Base font size used inside tracker cards.",debug:"Enable verbose diagnostics logging for troubleshooting.",includeContextInDiagnostics:"Include extraction prompt/context text in diagnostics dumps (larger logs).",includeGraphInDiagnostics:"Include graph-open series payloads in diagnostics trace output."};for(const[t,e]of Object.entries(l)){const n=s.querySelector(`[data-k="${t}"]`);if(!n)continue;n.setAttribute("title",e);const a=n.closest("label");a?.setAttribute("title",e)}s.querySelector('[data-action="close"]')?.addEventListener("click",()=>{c(),xt()}),s.querySelector('[data-action="retrack"]')?.addEventListener("click",()=>{c(),t.onRetrack?.()}),s.querySelector('[data-action="clear-chat"]')?.addEventListener("click",()=>{c(),t.onClearCurrentChat?.()}),s.querySelector('[data-action="dump-diagnostics"]')?.addEventListener("click",()=>{c(),t.onDumpDiagnostics?.()}),s.querySelector('[data-action="clear-diagnostics"]')?.addEventListener("click",()=>{c(),t.onClearDiagnostics?.()})}({settings:yt,profileOptions:t?D(t):[],debugRecord:Dt,injectedPrompt:yt.debug?y():"",onSave:t=>{const e=Vt();e&&(yt=t,w(e,yt),Zt())},onRetrack:()=>{Kt("manual_refresh")},onClearCurrentChat:()=>{const t=Vt();t&&(function(t){for(const e of t.chat)e.extra&&delete e.extra[a];const e=t.chat?.[0];e?.extra&&delete e.extra[L],t.chatMetadata&&Object.prototype.hasOwnProperty.call(t.chatMetadata,a)&&(delete t.chatMetadata[a],t.saveMetadataDebounced?.());const n=B(t);try{localStorage.removeItem(n)}catch{}try{const e=q(t),n=H();Object.prototype.hasOwnProperty.call(n,e)&&(delete n[e],J(n))}catch{}}(t),Bt(t),_t=[],wt=null,It=null,Dt=null,Mt={phase:"idle",done:0,total:0,messageIndex:null},t.saveChatDebounced?.(),t.saveChat?.(),Zt())},onDumpDiagnostics:()=>{const t=Vt();if(!t||!yt)return;const e=yt,n=t=>e.includeGraphInDiagnostics?t:t.filter(t=>!t.includes(" graph.open ")),a=Dt?e.includeGraphInDiagnostics?Dt:{...Dt,trace:n(Dt.trace??[])}:null,s={timestamp:(new Date).toISOString(),scope:t.groupId?`group:${t.groupId}`:`char:${String(t.characterId??"unknown")}`,chatLength:t.chat.length,isExtracting:vt,runSequence:kt,trackerUiState:Mt,latestDataMessageIndex:It,latestDataTimestamp:wt?.timestamp??null,allCharacterNames:St,settings:{enabled:e.enabled,debug:e.debug,includeContextInDiagnostics:e.includeContextInDiagnostics,includeGraphInDiagnostics:e.includeGraphInDiagnostics,injectTrackerIntoPrompt:e.injectTrackerIntoPrompt,contextMessages:e.contextMessages,maxConcurrentCalls:e.maxConcurrentCalls,maxDeltaPerTurn:e.maxDeltaPerTurn,autoDetectActive:e.autoDetectActive,activityLookback:e.activityLookback,strictJsonRepair:e.strictJsonRepair,maxRetriesPerStat:e.maxRetriesPerStat},activity:Lt,promptInjectionPreview:e.debug?y():void 0,traceTailMemory:n(_t.slice(-150)),traceTailPersisted:n(qt(t).slice(-300)),lastDebugRecord:a};console.log("[BetterSimTracker] diagnostics-dump",s);const o=JSON.stringify(s,null,2);navigator.clipboard?.writeText(o).then(()=>console.log("[BetterSimTracker] diagnostics copied to clipboard"),()=>console.log("[BetterSimTracker] diagnostics clipboard copy failed"))},onClearDiagnostics:()=>{const t=Vt();t&&(Bt(t),_t=[],Dt=null,zt("diagnostics.cleared"),Zt())}})}function ee(){xt()}function ne(){const t=Vt();return!(!t||!yt)&&(yt.enabled=!yt.enabled,w(t,yt),yt.enabled?(Ut(t),Zt()):(async function(){const t=await x(),e=t?.setExtensionPrompt;if("function"!=typeof e)return;const n=Number((t?.extension_prompt_types??{}).IN_CHAT??3);m="",e(h,"",n,0,!1)}(),bt(),document.querySelectorAll(`.${K}`).forEach(t=>t.remove()),document.getElementById(s)?.remove(),document.querySelector(".bst-settings-backdrop")?.remove(),document.querySelector(".bst-settings")?.remove(),bt()),yt.enabled)}async function ae(){await Kt("manual_refresh")}async function se(){const t=Vt();t?(yt=function(t){const e=(t.extensionSettings??{})[a]??{},n=function(){try{const t=localStorage.getItem(M);if(!t)return{};const e=JSON.parse(t);return e&&"object"==typeof e?e:{}}catch{return{}}}();return A({...S,...n,...e})}(t),yt.debug&&zt("init",{groupId:t.groupId??null,characterId:t.characterId??null,chatLength:t.chat.length}),function(t){const n=t.event_types,a=t.eventSource;n.GENERATION_STARTED&&a.on(n.GENERATION_STARTED,(n,a,s)=>{if(vt)return void zt("event.generation_started_ignored",{reason:"tracker_extraction_in_progress"});const o=String(n??""),r=Boolean(s);if(r||"quiet"===o)return void zt("event.generation_started_ignored",{reason:r?"dry_run":"quiet_generation",type:o,dryRun:r});Pt=!0,Rt=!1,jt=Ht(t);const i=function(t){const n=t.chat[t.chat.length-1];return n&&e(n)?t.chat.length+1:t.chat.length}(t);zt("event.generation_started",{targetIndex:i,type:o,startLastAiIndex:jt}),Xt(t,{phase:"generating",done:0,total:0,messageIndex:i}),Ft(),Ut(t)}),a.on(n.GENERATION_ENDED,()=>{if(vt)zt("event.generation_ended_ignored",{reason:"tracker_extraction_in_progress"});else if(Pt){if(!Rt)return Pt=!1,jt=null,zt("event.generation_ended_ignored",{reason:"no_new_ai_message_rendered"}),Xt(t,{phase:"idle",done:0,total:0,messageIndex:It}),void Ft();Pt=!1,jt=null,zt("event.generation_ended"),Wt("GENERATION_ENDED")}else zt("event.generation_ended_ignored",{reason:"non_chat_or_quiet_generation"})}),a.on(n.CHAT_CHANGED,()=>{Pt=!1,Rt=!1,jt=null,zt("event.chat_changed"),Yt()}),n.GROUP_CHAT_UPDATED&&a.on(n.GROUP_CHAT_UPDATED,()=>{zt("event.group_chat_updated"),Yt()}),n.CHARACTER_MESSAGE_RENDERED&&a.on(n.CHARACTER_MESSAGE_RENDERED,()=>{if(zt("event.character_message_rendered"),Pt){const e=Ht(t);null!=e&&(null==jt||e>jt)&&(Rt=!0,zt("event.character_message_rendered_marked_new_ai",{currentLastAi:e,startLastAiIndex:jt}))}if("generating"===Mt.phase){const e=Ht(t);Xt(t,{...Mt,messageIndex:e})}Yt(120)}),n.USER_MESSAGE_RENDERED&&a.on(n.USER_MESSAGE_RENDERED,()=>{zt("event.user_message_rendered"),Yt(120)}),n.CHAT_LOADED&&a.on(n.CHAT_LOADED,()=>{Pt=!1,Rt=!1,jt=null,zt("event.chat_loaded"),Yt()}),n.APP_READY&&a.on(n.APP_READY,()=>{zt("event.app_ready"),Yt()}),n.MESSAGE_DELETED&&a.on(n.MESSAGE_DELETED,()=>{Pt=!1,Rt=!1,jt=null,zt("event.message_deleted"),Yt(60)}),n.CHAT_DELETED&&a.on(n.CHAT_DELETED,()=>{Pt=!1,Rt=!1,jt=null,zt("event.chat_deleted"),Yt(60)}),n.MESSAGE_EDITED&&a.on(n.MESSAGE_EDITED,t=>{const e=Qt(t);zt("event.message_edited",{messageIndex:e}),Yt(),Wt("MESSAGE_EDITED",e??void 0)});const s=["MESSAGE_SWIPED","SWIPE_CHANGED","MESSAGE_SWIPE_CHANGED","MESSAGE_SWIPE_DELETED"];for(const t of s){const e=n[t];e&&a.on(e,e=>{const n=Qt(e);zt("event.swipe",{event:t,messageIndex:n}),Yt(),Wt(t,n??void 0)})}}(t),Zt(),setTimeout(()=>Zt(),500),setTimeout(()=>Zt(),1500),setTimeout(()=>Zt(),3e3),setTimeout(()=>Zt(),6e3),window.BetterSimTracker={openSettings:te,closeSettings:ee,toggle:ne,refresh:ae}):console.warn("[BetterSimTracker] SillyTavern context not available.")}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{se()}):se()})();